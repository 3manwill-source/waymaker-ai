<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WayMaker AI - Enhanced Community Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- WayMaker Admin Extension -->
    <script src="waymaker-admin.js"></script>
    <style>
        /* Prevent entire page from scrolling */
        html, body {
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        
        /* Enhanced message styling with edit/delete functionality */
        .message:hover .message-actions {
            opacity: 1 !important;
        }
        
        .message-actions {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .typing-cursor {
            color: #3b82f6;
            font-weight: bold;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .message-content {
            transition: transform 0.2s ease;
        }
        
        .user-badge {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            font-size: 0.65rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.375rem;
            font-weight: bold;
        }
        
        /* ✅ FIXED: Enhanced sidebar with proper layout distribution */
        .sidebar-section {
            background: #1f2937;
            border: 1px solid #374151;
            margin: 0.5rem;
            border-radius: 0.5rem;
            flex-shrink: 0; /* ✅ ADDED: Prevent unwanted shrinking */
        }
        
        .sidebar-full-height {
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 10px 0;
        }
        
        /* ✅ FIXED: Community Members section with REDUCED height for more History space */
        .sidebar-section.community-members {
            max-height: 150px; /* ✅ REDUCED: Much less height for community to give History more space */
            display: flex;
            flex-direction: column;
        }
        
        .community-members .p-2 {
            flex-shrink: 0;
        }
        
        #userList {
            flex: 1;
            overflow-y: auto;
            min-height: 60px;
            max-height: 140px; /* ✅ REDUCED: Less space for user list */
        }
        
        /* ✅ FIXED: Enhanced Features and other sections - MUCH smaller to prevent overlap */
        .sidebar-section.fixed-size {
            flex-shrink: 0;
            max-height: 60px; /* ✅ REDUCED: Much smaller to prevent overlap completely */
            overflow: hidden; /* ✅ ADDED: Hide overflow to prevent expansion */
        }
        
        /* ✅ FIXED: History section with MORE space and visible borders when scrollable */
        .sidebar-section.fill-remaining {
            flex: 1 1 auto !important;
            min-height: 400px !important; /* ✅ INCREASED: Much more minimum height for History */
            max-height: none !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden;
            border: 4px solid transparent; /* ✅ ENHANCED: Even thicker border for better visibility */
            border-radius: 8px; /* ✅ ADDED: Rounded corners for better appearance */
            transition: border-color 0.3s ease; /* ✅ ADDED: Smooth border transition */
        }
        
        /* ✅ ENHANCED: VERY visible border when History is scrollable */
        .sidebar-section.fill-remaining.scrollable {
            border-color: #ef4444 !important; /* ✅ CHANGED: Red border for maximum visibility */
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.5) !important; /* ✅ ENHANCED: Stronger glow effect */
        }
        
        .history-content {
            flex: 1 !important;
            overflow-y: auto !important;
            min-height: 0 !important; /* ✅ FIXED: Allow proper flexing */
            max-height: none !important; /* ✅ FIXED: Remove max-height restriction */
            padding: 0.5rem; /* ✅ ADDED: Proper padding */
        }
        
        /* ✅ ADDED: Visual indicators for scrollable sections */
        .community-members #userList::-webkit-scrollbar {
            width: 3px;
        }
        
        .community-members #userList::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .community-members #userList::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 1px;
        }
        
        .community-members #userList::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        /* ✅ ADDED: Fade effect at bottom of community list when scrollable */
        .community-members::after {
            content: '';
            position: absolute;
            bottom: 8px;
            left: 8px;
            right: 8px;
            height: 20px;
            background: linear-gradient(transparent, #1f2937);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .community-members.scrollable::after {
            opacity: 1;
        }
        
        /* ✅ ADDED: Enhanced History section styling */
        .history-content {
            position: relative;
        }
        
        .history-content::-webkit-scrollbar {
            width: 3px;
        }
        
        .history-content::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .history-content::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 1px;
        }
        
        .history-content::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        /* ✅ ADDED: History selection modal styling */
        #historyModal {
            backdrop-filter: blur(4px);
        }
        
        .history-select-item {
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        
        .history-select-item:hover {
            border-left-color: #3b82f6;
            transform: translateX(2px);
        }
        
        .history-select-item:active {
            background: #4b5563 !important;
        }
        
        /* ✅ ADDED: Message action icons styling */
        .action-icon {
            background: #4b5563;
            color: #d1d5db;
            border: none;
            border-radius: 0.25rem;
            padding: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-icon:hover {
            background: #6b7280;
            transform: scale(1.1);
        }
        
        .message-action-icons {
            justify-content: center;
        }
        
        /* Specific icon colors */
        .action-icon:nth-child(1) { background: #f59e0b; } /* Suggest - amber */
        .action-icon:nth-child(1):hover { background: #d97706; }
        
        .action-icon:nth-child(2) { background: #059669; } /* Edit - emerald */
        .action-icon:nth-child(2):hover { background: #047857; }
        
        .action-icon:nth-child(3) { background: #10b981; } /* Rate up - green */
        .action-icon:nth-child(3):hover { background: #059669; }
        
        .action-icon:nth-child(4) { background: #ef4444; } /* Rate down - red */
        .action-icon:nth-child(4):hover { background: #dc2626; }
        
        .action-icon:nth-child(5) { background: #8b5cf6; } /* TTS - violet */
        .action-icon:nth-child(5):hover { background: #7c3aed; }
        
        .action-icon:nth-child(6) { background: #06b6d4; } /* Voice - cyan */
        .action-icon:nth-child(6):hover { background: #0891b2; }
        
        .action-icon:nth-child(7) { background: #dc2626; } /* Delete - red */
        .action-icon:nth-child(7):hover { background: #b91c1c; }
        
        /* ✅ ENHANCED: Make suggest icon MUCH more prominent */
        .suggest-icon {
            background: #f59e0b !important; /* Bright amber */
            animation: pulse-suggest 2s infinite;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.8) !important; /* ✅ STRONGER glow */
            border: 2px solid #fbbf24 !important; /* ✅ ADDED: Bright border */
            font-size: 1.2em !important; /* ✅ ADDED: Larger font size */
            min-width: 32px !important; /* ✅ ADDED: Minimum width */
            min-height: 32px !important; /* ✅ ADDED: Minimum height */
        }
        
        .suggest-icon:hover {
            background: #d97706 !important;
            transform: scale(1.3) !important; /* ✅ INCREASED: Bigger hover effect */
            box-shadow: 0 0 20px rgba(245, 158, 11, 1) !important; /* ✅ STRONGER hover glow */
        }
        
        @keyframes pulse-suggest {
            0%, 100% { box-shadow: 0 0 5px rgba(245, 158, 11, 0.5); }
            50% { box-shadow: 0 0 15px rgba(245, 158, 11, 0.8); }
        }
        
        /* ✅ FIXED: Make ALL action icons always visible */
        .message-action-icons {
            opacity: 1 !important; /* ✅ CHANGED: Always fully visible */
            transition: opacity 0.3s ease;
        }
        
        .message:hover .message-action-icons {
            opacity: 1;
        }
        
        /* ✅ ENHANCED: Suggest icon ALWAYS visible and extra prominent for assistant messages */
        .message-action-icons .suggest-icon {
            opacity: 1 !important; /* ✅ ADDED: Always fully visible */
            position: relative !important;
            z-index: 10 !important; /* ✅ ADDED: Bring to front */
        }
        
        /* ✅ ADDED: Suggestions container styling */
        .suggestions-container {
            animation: fadeInUp 0.3s ease-out;
            border-left: 3px solid #3b82f6;
        }
        
        .suggestion-item {
            border-left: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .suggestion-item:hover {
            border-left-color: #60a5fa;
            transform: translateX(2px);
            background: rgba(59, 130, 246, 0.1) !important;
        }
        
        .suggestion-item:active {
            transform: translateX(1px);
            background: rgba(59, 130, 246, 0.2) !important;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .compact-button {
            background: #374151;
            color: #d1d5db;
            transition: all 0.2s ease;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
        }
        
        .compact-button:hover {
            background: #4b5563;
            color: #f9fafb;
        }
        
        .compact-button.prayer { background: #7c3aed; color: white; }
        .compact-button.prayer:hover { background: #6d28d9; }
        .compact-button.verse { background: #059669; color: white; }
        .compact-button.verse:hover { background: #047857; }
        .compact-button.export { background: #2563eb; color: white; }
        .compact-button.export:hover { background: #1d4ed8; }
        .compact-button.exit { background: #dc2626; color: white; }
        .compact-button.exit:hover { background: #b91c1c; }
        .compact-button.new-session { background: #d97706; color: white; }
        .compact-button.new-session:hover { background: #b45309; }
        
        .history-item {
            background: #374151;
            color: #d1d5db;
            transition: all 0.2s ease;
            font-size: 0.7rem;
            padding: 0.25rem;
            cursor: pointer;
            border-radius: 0.375rem;
            margin-bottom: 0.25rem;
        }
        
        .history-item:hover {
            background: #4b5563;
        }
        
        /* MINIMAL SCROLLBAR STYLING */
        ::-webkit-scrollbar {
            width: 2px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 1px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Specific minimal scrollbars for different sections */
        #historyList::-webkit-scrollbar,
        #messagesContainer::-webkit-scrollbar {
            width: 2px;
        }
        
        #historyList::-webkit-scrollbar-track,
        #messagesContainer::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #historyList::-webkit-scrollbar-thumb,
        #messagesContainer::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 1px;
        }
        
        #historyList::-webkit-scrollbar-thumb:hover,
        #messagesContainer::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Firefox minimal scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: #4b5563 transparent;
        }
        
        .chat-input {
            background: #374151;
            border: 2px solid #4b5563;
            color: #f9fafb;
            font-size: 0.875rem;
        }
        
        .chat-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .compact-message {
            font-size: 0.8rem;
            line-height: 1.3;
        }

        .compact-user-list {
            font-size: 0.7rem;
        }
        
        /* ✅ ADDED: Community refresh styling */
        #manualRefreshBtn {
            transition: all 0.2s ease;
        }
        
        #manualRefreshBtn:hover {
            transform: scale(1.1);
        }
        
        #lastRefreshTime {
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        #lastRefreshTime:hover {
            opacity: 1;
        }

        .top-action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Enhanced message action buttons */
        .action-button {
            background: #4b5563;
            color: #d1d5db;
            border: none;
            border-radius: 0.25rem;
            padding: 0.125rem 0.375rem;
            font-size: 0.625rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-button:hover {
            background: #6b7280;
            color: #f9fafb;
        }

        .action-button.edit {
            background: #059669;
            color: white;
        }

        .action-button.edit:hover {
            background: #047857;
        }

        .action-button.delete {
            background: #dc2626;
            color: white;
        }

        .action-button.delete:hover {
            background: #b91c1c;
        }

        /* Admin-specific styles */
        .admin-badge {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            font-size: 0.6rem;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .admin-edit {
            background: #f59e0b !important;
            color: white !important;
        }

        .admin-edit:hover {
            background: #d97706 !important;
        }

        .admin-delete {
            background: #ef4444 !important;
            color: white !important;
        }

        .admin-delete:hover {
            background: #dc2626 !important;
        }

        #adminPanel {
            border-left: 3px solid #dc2626;
        }

        #adminPanel button {
            font-size: 0.6rem;
            padding: 0.25rem 0.5rem;
        }

        /* Edit mode styling */
        .edit-mode .message-content {
            background: #374151 !important;
            border: 2px solid #3b82f6;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }

        .edit-controls {
            margin-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        /* API Status indicator */
        .api-status {
            font-size: 0.65rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.375rem;
            font-weight: bold;
        }

        .api-status.connected {
            background: #10b981;
            color: white;
        }

        .api-status.disconnected {
            background: #ef4444;
            color: white;
        }

        .api-status.fallback {
            background: #f59e0b;
            color: white;
        }

        /* Loading animation */
        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #374151;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error state styling */
        .error-state {
            background: #dc2626;
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin: 0.5rem;
        }

        .success-state {
            background: #059669;
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin: 0.5rem;
        }

        /* Settings Panel Styling */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-panel {
            background: #1f2937;
            border: 2px solid #374151;
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .setting-group {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #374151;
        }

        .setting-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .setting-label {
            color: #f9fafb;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
        }

        .setting-description {
            color: #9ca3af;
            font-size: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .font-size-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .font-size-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #4b5563;
            background: #374151;
            color: #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .font-size-btn:hover {
            border-color: #6b7280;
            background: #4b5563;
        }

        .font-size-btn.active {
            border-color: #3b82f6;
            background: #1d4ed8;
            color: white;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .toggle-switch {
            position: relative;
            width: 3rem;
            height: 1.5rem;
            background: #4b5563;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #3b82f6;
        }

        .toggle-slider {
            position: absolute;
            top: 0.125rem;
            left: 0.125rem;
            width: 1.25rem;
            height: 1.25rem;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(1.5rem);
        }

        .preference-checkbox {
            margin-right: 0.5rem;
            transform: scale(1.2);
        }

        .preference-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            color: #d1d5db;
        }

        .preference-item:last-child {
            margin-bottom: 0;
        }

        .settings-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }

        .settings-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .settings-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .settings-btn.primary:hover {
            background: #1d4ed8;
        }

        .settings-btn.secondary {
            background: #6b7280;
            color: white;
        }

        .settings-btn.secondary:hover {
            background: #4b5563;
        }

        /* Font size classes */
        .font-small { font-size: 0.75rem; }
        .font-medium { font-size: 0.875rem; }
        .font-large { font-size: 1rem; }
        .font-xlarge { font-size: 1.125rem; }

        /* Light theme classes */
        .light-theme {
            background: #f9fafb !important;
            color: #111827 !important;
        }

        .light-theme .bg-gray-900 { background: #f9fafb !important; }
        .light-theme .bg-gray-800 { background: #e5e7eb !important; }
        .light-theme .bg-gray-700 { background: #d1d5db !important; }
        .light-theme .text-white { color: #111827 !important; }
        .light-theme .text-gray-300 { color: #374151 !important; }
        .light-theme .border-gray-700 { border-color: #d1d5db !important; }
        .light-theme .border-gray-600 { border-color: #9ca3af !important; }

        /* Enhanced Font Size Controls */
        .font-small .message-content { font-size: 0.75rem !important; line-height: 1.2; }
        .font-small .compact-message { font-size: 0.7rem !important; }
        .font-small .text-xs { font-size: 0.65rem !important; }
        .font-small .text-sm { font-size: 0.75rem !important; }
        
        .font-medium .message-content { font-size: 0.875rem !important; line-height: 1.3; }
        .font-medium .compact-message { font-size: 0.8rem !important; }
        
        .font-large .message-content { font-size: 1rem !important; line-height: 1.4; }
        .font-large .compact-message { font-size: 0.95rem !important; }
        .font-large .text-xs { font-size: 0.8rem !important; }
        .font-large .text-sm { font-size: 0.9rem !important; }
        
        .font-xlarge .message-content { font-size: 1.125rem !important; line-height: 1.5; }
        .font-xlarge .compact-message { font-size: 1.05rem !important; }
        .font-xlarge .text-xs { font-size: 0.85rem !important; }
        .font-xlarge .text-sm { font-size: 1rem !important; }
        
        /* Compact Mode Styling */
        .compact-mode .message {
            margin-bottom: 0.25rem !important;
        }
        
        .compact-mode .message-content {
            padding: 0.375rem 0.75rem !important;
            line-height: 1.2 !important;
        }
        
        .compact-mode .sidebar-section {
            margin: 0.25rem !important;
            padding: 0.5rem !important;
        }
        
        .compact-mode .setting-group {
            margin-bottom: 1rem !important;
            padding-bottom: 0.75rem !important;
        }
        
        .compact-mode .welcome-banner {
            padding: 0.25rem !important;
            margin: 0.5rem !important;
        }
        
        /* Light theme message styling */
        .light-theme .message-content {
            background: #ffffff !important;
            border: 1px solid #e5e7eb !important;
            color: #111827 !important;
        }
        
        .light-theme .bg-blue-600 {
            background: #2563eb !important;
            color: white !important;
        }
        
        .light-theme .bg-purple-600 {
            background: #7c3aed !important;
            color: white !important;
        }
        
        .light-theme .settings-panel {
            background: #ffffff !important;
            border-color: #d1d5db !important;
            color: #111827 !important;
        }
        
        .light-theme .setting-label {
            color: #111827 !important;
        }
        
        .light-theme .preference-item {
            color: #374151 !important;
        }

        /* ✅ UPDATED: Scroll-to-bottom button positioning */
        .scroll-to-bottom {
            position: fixed;
            bottom: 160px; /* ✅ INCREASED: Move higher to avoid input area */
            right: 20px;
            width: 40px;
            height: 40px;
            background: #3b82f6;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 15;
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }
        
        .scroll-to-bottom.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .scroll-to-bottom:hover {
            background: #1d4ed8;
            transform: scale(1.1);
        }

        /* ✅ FIXED: Optimized layout for better scrolling */
        .chat-container {
            height: 100vh;
            overflow: hidden;
        }
        
        /* ✅ FIXED: Chat area with proper height calculation to avoid input overlap */
        .chat-area {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-bottom: 0; /* Remove any padding that might interfere */
        }
        
        /* ✅ FIXED: Messages container with extra large space for input area */
        #messagesContainer {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0.75rem;
            padding-bottom: 220px; /* ✅ EXTRA LARGE INCREASE: Massive space for input area */
            scroll-behavior: smooth;
            margin-bottom: 0;
            box-sizing: border-box;
        }
        
        /* ✅ FIXED: Input area with explicit height and better positioning */
        .input-area {
            position: fixed;
            bottom: 0;
            right: 0;
            left: 256px; /* Width of sidebar (w-64 = 256px) */
            background: #1f2937;
            border-top: 1px solid #374151;
            z-index: 10;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
            padding: 1rem;
            min-height: 140px; /* ✅ INCREASED: Explicit minimum height */
            max-height: 200px; /* ✅ ADDED: Maximum height to prevent overflow */
            overflow: visible; /* ✅ ADDED: Ensure content is visible */
        }

        .welcome-banner {
            min-height: auto;
            padding: 0.5rem;
            margin-bottom: 0.5rem; /* ✅ ADDED: Space below banner */
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    
    <!-- Enhanced Header with User Info and Actions -->
    <div class="bg-gray-800 border-b border-gray-700 p-2">
         <div class="flex justify-between items-start">
            <div class="flex-1">
                <h1 class="text-white text-lg font-bold flex items-center gap-2 mb-1">
                    ✝️⚪ WayMaker AI - Enhanced Community Chat
                    <span class="text-xs text-gray-300 font-normal">Your path to living God's will — step by step</span>
                </h1>
                
                <!-- Action Buttons in Header -->
                <div class="top-action-buttons">
                    <button id="prayerBtn" class="compact-button prayer" title="Prayer request">🙏 Prayer</button>
                    <button id="verseBtn" class="compact-button verse" title="Bible verse lookup">📖 Verse</button>
                    <button id="exportBtn" class="compact-button export" title="Export chat">💾 Export</button>
                    <button id="newSessionBtn" class="compact-button new-session" title="New session">🔄 New</button>
                    <button id="exitChatBtn" class="compact-button exit" title="Exit chat">🚪 Exit</button>
                </div>
            </div>
            
            <div class="text-right">
                <div class="text-white font-semibold text-sm" id="userDisplay">Welcome, Friend!</div>
                <div class="flex gap-1 mt-1">
                    <span class="user-badge" id="userTypeBadge">Individual</span>
                    <span class="user-badge" id="accessTierBadge">Basic</span>
                    <span class="api-status connected" id="apiStatus">✓ Connected</span>
                    <button id="settingsBtn" class="user-badge bg-gray-600 hover:bg-gray-500 cursor-pointer" title="Settings">⚙️</button>
                    <button id="headerExitBtn" class="user-badge bg-red-500 hover:bg-red-600 cursor-pointer" title="Exit">🚪</button>
                </div>
                <div class="text-gray-400 text-xs mt-1">
                    <span id="sessionInfo">Session-based (No data stored)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="settings-modal" style="display: none;">
        <div class="settings-panel">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    ⚙️ Settings Panel
                </h2>
                <button id="closeSettingsBtn" class="text-gray-400 hover:text-white text-2xl font-bold" title="Close Settings">
                    ×
                </button>
            </div>

            <!-- Font Size Controls -->
            <div class="setting-group">
                <label class="setting-label">📝 Font Size</label>
                <div class="setting-description">
                    Adjust text size for better readability in chat messages
                </div>
                <div class="font-size-buttons">
                    <button class="font-size-btn" data-size="small">Small</button>
                    <button class="font-size-btn active" data-size="medium">Medium</button>
                    <button class="font-size-btn" data-size="large">Large</button>
                    <button class="font-size-btn" data-size="xlarge">Extra Large</button>
                </div>
            </div>

            <!-- Theme Toggle -->
            <div class="setting-group">
                <label class="setting-label">🌙 Theme</label>
                <div class="setting-description">
                    Switch between dark and light themes for comfortable viewing
                </div>
                <div class="theme-toggle">
                    <span class="text-gray-300">Dark</span>
                    <div class="toggle-switch" id="themeToggle">
                        <div class="toggle-slider"></div>
                    </div>
                    <span class="text-gray-300">Light</span>
                </div>
            </div>

            <!-- Notification Preferences -->
            <div class="setting-group">
                <label class="setting-label">🔔 Notifications</label>
                <div class="setting-description">
                    Configure how you receive notifications in the chat
                </div>
                <div class="preference-item">
                    <input type="checkbox" id="soundNotifications" class="preference-checkbox" checked>
                    <label for="soundNotifications">Sound notifications for new messages</label>
                </div>
                <div class="preference-item">
                    <input type="checkbox" id="joinLeaveNotifications" class="preference-checkbox" checked>
                    <label for="joinLeaveNotifications">Show user join/leave notifications</label>
                </div>
                <div class="preference-item">
                    <input type="checkbox" id="typingIndicator" class="preference-checkbox" checked>
                    <label for="typingIndicator">Show typing indicators</label>
                </div>
            </div>

            <!-- Chat Preferences -->
            <div class="setting-group">
                <label class="setting-label">💬 Chat Behavior</label>
                <div class="setting-description">
                    Customize your chat experience and interface preferences
                </div>
                <div class="preference-item">
                    <input type="checkbox" id="enterToSend" class="preference-checkbox" checked>
                    <label for="enterToSend">Send message with Enter key</label>
                </div>
                <div class="preference-item">
                    <input type="checkbox" id="timestampDisplay" class="preference-checkbox" checked>
                    <label for="timestampDisplay">Show message timestamps</label>
                </div>
                <div class="preference-item">
                    <input type="checkbox" id="compactMode" class="preference-checkbox">
                    <label for="compactMode">Compact message display</label>
                </div>
                <div class="preference-item">
                    <input type="checkbox" id="autoScroll" class="preference-checkbox" checked>
                    <label for="autoScroll">Auto-scroll to new messages</label>
                </div>
            </div>

            <!-- Privacy & Data -->
            <div class="setting-group">
                <label class="setting-label">🔒 Privacy & Data</label>
                <div class="setting-description">
                    Control how your data is handled during the session
                </div>
                <div class="preference-item">
                    <input type="checkbox" id="saveHistory" class="preference-checkbox" checked>
                    <label for="saveHistory">Save conversation history locally</label>
                </div>
                <div class="preference-item">
                    <input type="checkbox" id="shareAnalytics" class="preference-checkbox">
                    <label for="shareAnalytics">Share anonymous usage analytics</label>
                </div>
            </div>

            <!-- Settings Action Buttons -->
            <div class="settings-buttons">
                <button id="resetSettingsBtn" class="settings-btn secondary">Reset to Defaults</button>
                <button id="saveSettingsBtn" class="settings-btn primary">Save Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="flex chat-container">
        
        <!-- Enhanced Full-Height Sidebar -->
        <div class="w-64 bg-gray-800 border-r border-gray-700 sidebar-full-height">
            
            <!-- ✅ FIXED: Community Members with scroll limit -->
            <div class="sidebar-section community-members">
                <div class="p-2 border-b border-gray-600 flex-shrink-0">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="font-semibold text-white text-sm">Community Members</h3>
                        <button id="manualRefreshBtn" class="text-xs text-gray-400 hover:text-white cursor-pointer" title="Refresh community list">
                            🔄
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 mb-1" id="lastRefreshTime">
                        Auto-refresh: Starting...
                    </div>
                </div>
                <ul id="userList" class="space-y-0.5 compact-user-list px-2 pb-2"></ul>
            </div>
            
            <!-- ✅ FIXED: Enhanced Features with fixed size -->
            <div class="sidebar-section fixed-size">
                <div class="p-2 border-b border-gray-600">
                    <h4 class="font-semibold text-white mb-1 text-sm">Enhanced Features</h4>
                    <div class="grid grid-cols-2 gap-1 text-xs">
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ✏️ Edit
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ❌ Delete
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            👍👎 Rate
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ❓ Suggest
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            🔊 TTS
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            🎤 Voice
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            📁 Upload
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            📖 Study
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            💾 Export
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            🚪 Exit
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ✅ FIXED: WayMaker AI Triggers with fixed size -->
            <div class="sidebar-section fixed-size">
                <div class="p-2 border-b border-gray-600">
                    <h4 class="font-semibold text-white mb-1 text-sm">WayMaker AI responds to:</h4>
                    <div class="grid grid-cols-2 gap-1 text-xs">
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            🔷 WayMaker
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            📖 Biblical
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            🙏 Prayer
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            🌟 Spiritual
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            💭 Faith
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            👥 Community
                        </div>
                    </div>
                </div>
            </div>

            <!-- ✅ FIXED: Live API Status with fixed size -->
            <div class="sidebar-section fixed-size">
                <div class="p-2 border-b border-gray-600">
                    <h4 class="font-semibold text-white mb-1 text-sm">🔗 Connection Status</h4>
                    <ul class="text-xs text-gray-300 space-y-0.5">
                        <li id="apiStatusText">🔄 Testing connection...</li>
                        <li id="supabaseStatusText">🔄 Initializing real-time...</li>
                        <li id="lastApiCall">Last response: Initializing...</li>
                    </ul>
                </div>
            </div>
            
            <!-- ✅ FIXED: Enhanced History Section - Flexes to fill remaining space -->
            <div class="sidebar-section fill-remaining">
                <div class="p-2 border-b border-gray-600 flex-shrink-0">
                    <h4 class="font-semibold text-white mb-2 flex items-center gap-1 text-sm">📜 History</h4>
                </div>
                <div class="history-content">
                    <div class="space-y-1" id="historyList">
                        <!-- Dynamic history items -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="flex-1 chat-area bg-gray-900">
            <!-- Enhanced Welcome Banner -->
            <div class="bg-blue-900/20 border-l-4 border-blue-400 welcome-banner m-2 rounded-r-lg">
                <p class="text-xs text-blue-300">
                    <strong>🌟 WayMaker AI Community Chat</strong> 
                    <span id="welcomeMessage">Where faith meets fellowship - your spiritual home online!</span>
                </p>
            </div>
            
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
            
            <!-- Compact Input Area -->
            <div class="border-t border-gray-700 bg-gray-800 p-2 input-area">
                <div class="flex gap-1 mb-2">
                    <div class="px-2 py-1 bg-gray-700 border border-gray-600 rounded text-xs text-gray-300" id="userInfoDisplay">
                        <span class="loading-spinner"></span> Initializing...
                    </div>
                    <input type="file" id="fileInput" multiple class="hidden">
                    <button id="fileBtn" class="px-2 py-1 bg-orange-600 hover:bg-orange-700 text-white rounded text-xs border-none cursor-pointer" title="Upload files">📁</button>
                    <button id="voiceBtn" class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs border-none cursor-pointer" title="Voice input">🎤</button>
                    <button id="clearBtn" class="px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs border-none cursor-pointer" title="Clear chat">🗑️</button>
                </div>
                
                <div class="flex gap-2">
                    <input type="text" id="messageInput" 
                           placeholder="Share with community, ask questions, or request prayer..."
                           class="chat-input flex-1 px-3 py-2 rounded-full outline-none">
                    <button id="sendButton" 
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full font-medium text-sm border-none cursor-pointer">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ ADDED: Scroll-to-bottom button -->
    <button id="scrollToBottomBtn" class="scroll-to-bottom" title="Scroll to latest messages">
        ↓
    </button>

<script>
console.log('🚀 WayMaker AI Enhanced Community Chat starting...');

class WayMakerGroupChat {
    constructor() {
        console.log('🎯 Initializing WayMaker GroupChat...');
        
        // ✅ FIXED: Updated to correct Cloudflare Worker endpoint (no /chat-messages)
        this.apiUrl = 'https://waymaker-proxy.waymaker-ai.workers.dev/';
        this.apiKey = 'app-baSinqrorYUcF4rJZk8qfbpv'; // NEW API key
        this.conversationId = null;
        this.currentMessageId = null;
        this.messageCounter = 0;
        
        // Supabase Real-time system
        this.supabaseUrl = 'https://eoreanpxurhjsvihjzxv.supabase.co';
        this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvcmVhbnB4dXJoanN2aWhqenh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NTMwNjQsImV4cCI6MjA2NTQyOTA2NH0.IVClvbT2NhUyx_XH02bmJNA0fIo4Taf13Y-7oCY-SZI';
        this.supabase = null;
        this.presenceChannel = null;
        this.messagesChannel = null;
        this.activeUsers = [];
        
        // History system
        this.historyCategories = {
            prayer: [], bible_study: [], spiritual_guidance: [],
            community_fellowship: [], crisis_support: [], youth_family: []
        };
        
        // Edit functionality
        this.editingMessageId = null;
        this.originalMessageContent = '';
        
        // API status tracking
        this.lastApiSuccess = null;
        this.apiFailureCount = 0;
        
        // ✅ ADDED: Auto-refresh timer for community members
        this.userListRefreshTimer = null;
        this.lastUserListUpdate = null;
        
        // ✅ ADDED: Typing indicator timer for safety
        this.typingTimer = null;
        this.isTypingShown = false;
        
        // Initialization state
        this.isInitialized = false;
        this.initializationError = null;
        
        this.userInfo = this.extractUserInfoFromURL();
        console.log('👤 User info extracted:', this.userInfo);
        
        // Start initialization with better error handling
        this.init().catch(error => {
            console.error('❌ Initialization failed:', error);
            this.initializationError = error;
            this.showInitializationError(error);
        });
    }
    
    extractUserInfoFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const userInfo = {
            name: urlParams.get('name') || 'Friend',
            age: urlParams.get('age') || '18-25',
            language: urlParams.get('language') || 'English',
            type: urlParams.get('type') || 'individual',
            access: urlParams.get('access') || 'basic',
            familySize: urlParams.get('family_size') || null,
            referralCode: urlParams.get('referral') || null
        };
        
        console.log('📋 Extracted user info:', userInfo);
        return userInfo;
    }
    
    async init() {
        try {
            console.log('✅ Starting initialization sequence...');
            
            // Step 1: Update status immediately
            this.updateInitializationStatus('🔧 Updating interface...');
            
            // Step 2: Update UI immediately
            this.updateUserInterface();
            console.log('✅ UI updated');
            
            // Step 3: Bind elements and events (critical for basic functionality)
            this.updateInitializationStatus('📎 Binding controls...');
            this.bindElements();
            this.attachEvents();
            console.log('✅ Events attached');
            
            // Step 4: Load history (synchronous, quick)
            this.updateInitializationStatus('📜 Loading history...');
            this.loadHistoryCategories();
            this.updateHistoryDisplay();
            console.log('✅ History loaded');
            
            // Step 5: Add welcome message (immediate feedback)
            this.updateInitializationStatus('👋 Adding welcome message...');
            this.addWelcomeMessage();
            console.log('✅ Welcome message added');
            
            // Step 6: Update session info immediately
            this.updateSessionInfo();
            console.log('✅ Session info updated');
            
            // Step 7: Initialize async components (non-blocking)
            this.updateInitializationStatus('🌐 Connecting to services...');
            await this.initializeAsyncComponents();
            
            // Mark as initialized
            this.isInitialized = true;
            this.updateInitializationStatus('✅ Ready!');
            console.log('🎉 Enhanced group chat initialized successfully!');
            
            // ✅ ADDED: Start auto-refresh timer for community members
            this.startUserListAutoRefresh();
            
            // Final status update
            setTimeout(() => {
                this.updateInitializationStatus(`${this.userInfo.name} (${this.userInfo.age}, ${this.capitalizeFirst(this.userInfo.type.replace('_', ' '))})`);
            }, 2000);
            
        } catch (error) {
            console.error('❌ Initialization error:', error);
            this.initializationError = error;
            this.showInitializationError(error);
            throw error;
        }
    }
    
    updateInitializationStatus(message) {
        try {
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            if (userInfoDisplay) {
                if (message.startsWith('✅')) {
                    userInfoDisplay.innerHTML = `<span class="text-green-400">${message}</span>`;
                } else if (message.startsWith('❌') || message.startsWith('⚠️')) {
                    userInfoDisplay.innerHTML = `<span class="text-red-400">${message}</span>`;
                } else if (message.startsWith('🔄') || message.startsWith('🔧') || message.startsWith('📎') || message.startsWith('📜') || message.startsWith('👋') || message.startsWith('🌐')) {
                    userInfoDisplay.innerHTML = `<span class="loading-spinner"></span> ${message}`;
                } else {
                    userInfoDisplay.textContent = message;
                }
            }
        } catch (error) {
            console.error('❌ Error updating initialization status:', error);
        }
    }
    
    async initializeAsyncComponents() {
        console.log('🔄 Initializing async components...');
        
        try {
            // Initialize Supabase with timeout
            const supabasePromise = Promise.race([
                this.initializeSupabase(),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Supabase timeout')), 10000))
            ]);
            
            await supabasePromise.catch(error => {
                console.warn('⚠️ Supabase initialization failed:', error);
                this.updateConnectionStatus('supabase', false, 'Real-time chat unavailable');
                this.startLocalMode();
            });
            
            // Test API connection with timeout
            const apiPromise = Promise.race([
                this.testApiConnection(),
                new Promise((_, reject) => setTimeout(() => reject(new Error('API timeout')), 8000))
            ]);
            
            await apiPromise.catch(error => {
                console.warn('⚠️ API test failed:', error);
                this.updateApiStatus('fallback', 'API unavailable - using fallback');
            });
            
            console.log('✅ Async components initialized');
        } catch (error) {
            console.error('❌ Async component initialization failed:', error);
            // Continue with local mode
            this.startLocalMode();
        }
    }
    
    updateConnectionStatus(service, connected, message) {
        try {
            if (service === 'supabase') {
                const el = document.getElementById('supabaseStatusText');
                if (el) {
                    el.textContent = connected ? '✓ Real-time chat active' : `⚠️ ${message}`;
                    el.className = connected ? 'text-green-400' : 'text-yellow-400';
                }
            } else if (service === 'api') {
                const el = document.getElementById('apiStatusText');
                if (el) {
                    el.textContent = connected ? '✓ Connected to Dify API' : `⚠️ ${message}`;
                    el.className = connected ? 'text-green-400' : 'text-yellow-400';
                }
            }
        } catch (error) {
            console.error('❌ Error updating connection status:', error);
        }
    }
    
    showInitializationError(error) {
        console.error('❌ Showing initialization error:', error);
        
        this.updateInitializationStatus(`⚠️ Error: ${error.message}`);
        
        // Show error notification
        this.showNotification(`Initialization error: ${error.message}. Using offline mode.`, 'red');
        
        // Still try to provide basic functionality
        setTimeout(() => {
            this.startLocalMode();
            this.updateInitializationStatus(`${this.userInfo.name} (Offline Mode)`);
        }, 3000);
    }
    
    updateSessionInfo() {
        try {
            console.log('📱 Updating session info...');
            
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            if (userInfoDisplay && this.userInfo) {
                const sessionText = `${this.userInfo.name} (${this.userInfo.age}, ${this.capitalizeFirst(this.userInfo.type.replace('_', ' '))}`;
                userInfoDisplay.textContent = sessionText;
            }
            
            console.log('✅ Session info updated successfully');
        } catch (error) {
            console.error('❌ Error updating session info:', error);
        }
    }
    
    updateUserInterface() {
        try {
            console.log('🎨 Updating user interface...');
            
            const userDisplay = document.getElementById('userDisplay');
            if (userDisplay) {
                userDisplay.textContent = `Welcome, ${this.userInfo.name}!`;
            }
            
            const userTypeBadge = document.getElementById('userTypeBadge');
            if (userTypeBadge) {
                userTypeBadge.textContent = this.capitalizeFirst(this.userInfo.type.replace('_', ' '));
            }
            
            const accessTierBadge = document.getElementById('accessTierBadge');
            if (accessTierBadge) {
                accessTierBadge.textContent = this.capitalizeFirst(this.userInfo.access);
            }
            
            const sessionInfo = `${this.userInfo.age} • ${this.userInfo.language}`;
            const sessionInfoEl = document.getElementById('sessionInfo');
            if (sessionInfoEl) {
                sessionInfoEl.textContent = sessionInfo;
            }
            
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage) {
                welcomeMessage.textContent = `Real-time biblical guidance with edit/delete features and live Dify API connection!`;
            }
            
            console.log('✅ User interface updated successfully');
        } catch (error) {
            console.error('❌ Error updating user interface:', error);
        }
    }
    
    capitalizeFirst(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }
    
    bindElements() {
        try {
            console.log('🔗 Binding DOM elements...');
            
            this.messagesContainer = document.getElementById('messagesContainer');
            this.messageInput = document.getElementById('messageInput');
            this.sendButton = document.getElementById('sendButton');
            this.userList = document.getElementById('userList');
            this.historyList = document.getElementById('historyList');
            this.fileInput = document.getElementById('fileInput');
            this.fileBtn = document.getElementById('fileBtn');
            this.voiceBtn = document.getElementById('voiceBtn');
            this.clearBtn = document.getElementById('clearBtn');
            this.prayerBtn = document.getElementById('prayerBtn');
            this.verseBtn = document.getElementById('verseBtn');
            this.exportBtn = document.getElementById('exportBtn');
            this.newSessionBtn = document.getElementById('newSessionBtn');
            this.exitChatBtn = document.getElementById('exitChatBtn');
            this.headerExitBtn = document.getElementById('headerExitBtn');
            this.settingsBtn = document.getElementById('settingsBtn');
            this.apiStatus = document.getElementById('apiStatus');
            this.apiStatusText = document.getElementById('apiStatusText');
            this.supabaseStatusText = document.getElementById('supabaseStatusText');
            this.lastApiCall = document.getElementById('lastApiCall');
            
            // Settings elements
            this.settingsModal = document.getElementById('settingsModal');
            this.closeSettingsBtn = document.getElementById('closeSettingsBtn');
            this.saveSettingsBtn = document.getElementById('saveSettingsBtn');
            this.resetSettingsBtn = document.getElementById('resetSettingsBtn');
            this.themeToggle = document.getElementById('themeToggle');
            this.fontSizeButtons = document.querySelectorAll('.font-size-btn');
            
            // ✅ ADDED: Scroll-to-bottom button
            this.scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
            
            // ✅ ADDED: Manual refresh button
            this.manualRefreshBtn = document.getElementById('manualRefreshBtn');
            this.lastRefreshTime = document.getElementById('lastRefreshTime');
            
            // Validate critical elements
            if (!this.messagesContainer) {
                throw new Error('Messages container not found');
            }
            if (!this.messageInput) {
                throw new Error('Message input not found');
            }
            if (!this.sendButton) {
                throw new Error('Send button not found');
            }
            
            console.log('✅ DOM elements bound successfully');
        } catch (error) {
            console.error('❌ Error binding elements:', error);
            throw error;
        }
    }
    
    attachEvents() {
        try {
            console.log('📎 Attaching event listeners...');
            
            if (this.sendButton) {
                this.sendButton.onclick = () => this.sendMessage();
            }
            
            if (this.messageInput) {
                this.messageInput.onkeypress = (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                };
            }
            
            if (this.fileBtn && this.fileInput) {
                this.fileBtn.onclick = () => this.fileInput.click();
            }
            
            if (this.voiceBtn) {
                this.voiceBtn.onclick = () => this.startVoiceInput();
            }
            
            if (this.clearBtn) {
                this.clearBtn.onclick = () => this.clearChat();
            }
            
            if (this.prayerBtn) {
                this.prayerBtn.onclick = () => this.handlePrayerRequest();
            }
            
            if (this.verseBtn) {
                this.verseBtn.onclick = () => this.handleVerseLookup();
            }
            
            if (this.exportBtn) {
                this.exportBtn.onclick = () => this.exportConversation();
            }
            
            if (this.newSessionBtn) {
                this.newSessionBtn.onclick = () => this.startNewSession();
            }
            
            if (this.exitChatBtn) {
                this.exitChatBtn.onclick = () => this.exitChat();
            }
            
            if (this.headerExitBtn) {
                this.headerExitBtn.onclick = () => this.exitChat();
            }
            
            if (this.settingsBtn) {
                this.settingsBtn.onclick = () => this.openSettings();
            }
            
            if (this.closeSettingsBtn) {
                this.closeSettingsBtn.onclick = () => this.closeSettings();
            }
            
            if (this.saveSettingsBtn) {
                this.saveSettingsBtn.onclick = () => this.saveSettings();
            }
            
            if (this.resetSettingsBtn) {
                this.resetSettingsBtn.onclick = () => this.resetSettings();
            }
            
            if (this.themeToggle) {
                this.themeToggle.onclick = () => this.toggleTheme();
            }
            
            // Font size buttons
            this.fontSizeButtons.forEach(btn => {
                btn.onclick = () => this.setFontSize(btn.dataset.size);
            });
            
            // Close settings when clicking outside
            if (this.settingsModal) {
                this.settingsModal.onclick = (e) => {
                    if (e.target === this.settingsModal) this.closeSettings();
                };
            }
            
            if (this.fileInput) {
                this.fileInput.onchange = (e) => this.handleFileUpload(e);
            }
            
            // ✅ ADDED: Scroll-to-bottom button functionality
            if (this.scrollToBottomBtn) {
                this.scrollToBottomBtn.onclick = () => this.forceScrollToBottom();
            }
            
            // ✅ ADDED: Scroll detection for messages container
            if (this.messagesContainer) {
                this.messagesContainer.addEventListener('scroll', () => this.handleScroll());
            }
            
            // ✅ ADDED: Manual refresh button
            if (this.manualRefreshBtn) {
                this.manualRefreshBtn.onclick = () => this.manualRefreshCommunity();
            }
            
            // ✅ ADDED: Community list scroll detection
            if (this.userList) {
                this.userList.addEventListener('scroll', () => this.updateCommunityScrollIndicator());
            }
            
            // ✅ ADDED: History content scroll detection for border visibility
            const historyContent = document.querySelector('.history-content');
            if (historyContent) {
                historyContent.addEventListener('scroll', () => this.updateHistoryScrollIndicator());
            }
            
            console.log('✅ Event listeners attached successfully');
        } catch (error) {
            console.error('❌ Error attaching events:', error);
            throw error;
        }
    }

    // Enhanced API Status Management
    async testApiConnection() {
        try {
            console.log('🔄 Testing API connection...');
            
            const testPayload = {
                inputs: {
                    user_name: this.userInfo.name,
                    topic: "test connection",
                    spiritual_context: "general"
                },
                query: "Test connection",
                response_mode: 'blocking',
                user: this.userInfo.name
            };

            const response = await fetch(this.apiUrl, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + this.apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(testPayload)
            });

            if (response.ok) {
                this.updateApiStatus('connected', 'Connected to Dify API');
                this.updateConnectionStatus('api', true, 'Connected');
                console.log('✅ API connection test successful');
                return true;
            } else {
                throw new Error(`API test failed: ${response.status}`);
            }
        } catch (error) {
            console.warn('⚠️ API connection test failed:', error);
            this.updateApiStatus('fallback', 'Using fallback responses');
            this.updateConnectionStatus('api', false, 'Using fallback responses');
            return false;
        }
    }

    updateApiStatus(status, message) {
        try {
            const statusEl = this.apiStatus;
            const textEl = this.apiStatusText;
            const lastCallEl = this.lastApiCall;
            
            if (statusEl) {
                statusEl.className = `api-status ${status}`;
                
                switch(status) {
                    case 'connected':
                        statusEl.textContent = '✓ Live API';
                        this.lastApiSuccess = new Date();
                        this.apiFailureCount = 0;
                        break;
                    case 'fallback':
                        statusEl.textContent = '⚠ Fallback';
                        this.apiFailureCount++;
                        break;
                    case 'disconnected':
                        statusEl.textContent = '✗ Offline';
                        this.apiFailureCount++;
                        break;
                }
            }
            
            if (textEl) {
                textEl.textContent = message;
            }
            
            if (lastCallEl) {
                const timeText = this.lastApiSuccess ? 
                    this.getTimeAgo(this.lastApiSuccess) : 'Initializing...';
                lastCallEl.textContent = `Last response: ${timeText}`;
            }
        } catch (error) {
            console.error('❌ Error updating API status:', error);
        }
    }
    
    // ✨ SUPABASE REALTIME GROUP CHAT SYSTEM ✨
    
    async initializeSupabase() {
        try {
            console.log('🚀 Initializing Supabase Group Chat...');
            
            if (typeof supabase === 'undefined') {
                throw new Error('Supabase library not loaded');
            }
            
            this.supabase = supabase.createClient(this.supabaseUrl, this.supabaseKey);
            console.log('✅ Supabase client created');
            
            await this.startSupabasePresence();
            await this.startSupabaseMessaging();
            
            this.updateConnectionStatus('supabase', true, 'Real-time chat active');
            
        } catch (error) {
            console.error('❌ Supabase initialization failed:', error);
            this.updateConnectionStatus('supabase', false, 'Real-time chat unavailable');
            this.startLocalMode();
        }
    }
    
    async startSupabasePresence() {
        try {
            this.presenceChannel = this.supabase.channel('waymaker-presence', {
                config: { presence: { key: this.userInfo.name } }
            });
            
            const presenceState = {
                user_id: this.userInfo.name,
                username: this.userInfo.name,
                user_type: this.userInfo.type,
                user_age: this.userInfo.age,
                online_at: new Date().toISOString()
            };
            
            this.presenceChannel.on('presence', { event: 'sync' }, () => {
                const presenceState = this.presenceChannel.presenceState();
                this.updateUserListFromSupabase(presenceState);
            });
            
            this.presenceChannel.on('presence', { event: 'join' }, ({ key, newPresences }) => {
                newPresences.forEach(presence => {
                    if (presence.username !== this.userInfo.name) {
                        this.showUserJoinedNotification(presence.username);
                    }
                });
            });
            
            this.presenceChannel.on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                leftPresences.forEach(presence => {
                    if (presence.username !== this.userInfo.name) {
                        this.showUserLeftNotification(presence.username);
                    }
                });
            });
            
            await this.presenceChannel.subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    await this.presenceChannel.track(presenceState);
                    console.log('✅ Presence tracked:', presenceState);
                    this.showJoinNotification();
                }
            });
            
        } catch (error) {
            console.error('❌ Presence setup failed:', error);
        }
    }
    
    async startSupabaseMessaging() {
        try {
            console.log('💬 Starting group messaging channel...');
            
            this.messagesChannel = this.supabase.channel('waymaker-messages');
            
            this.messagesChannel.on('broadcast', { event: 'new_message' }, (payload) => {
                console.log('📨 Received group message:', payload);
                
                if (payload.payload.sender !== this.userInfo.name) {
                    this.addMessageToUI(
                        payload.payload.content,
                        payload.payload.type,
                        payload.payload.sender,
                        payload.payload.shouldStream
                    );
                }
            });
            
            await this.messagesChannel.subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    console.log('✅ Group messaging channel subscribed');
                }
            });
            
        } catch (error) {
            console.error('❌ Group messaging setup failed:', error);
        }
    }
    
    async broadcastMessage(content, type, sender, shouldStream = false) {
        if (this.messagesChannel) {
            try {
                await this.messagesChannel.send({
                    type: 'broadcast',
                    event: 'new_message',
                    payload: {
                        content: content,
                        type: type,
                        sender: sender,
                        shouldStream: shouldStream,
                        timestamp: new Date().toISOString()
                    }
                });
                console.log('📤 Message broadcasted to group');
            } catch (error) {
                console.error('❌ Failed to broadcast message:', error);
            }
        }
    }
    
    updateUserListFromSupabase(presenceState) {
        const users = [];
        
        users.push({ name: 'WayMaker AI', isBot: true, joinedAt: 0 });
        
        Object.values(presenceState).forEach(presences => {
            presences.forEach(presence => {
                if (!presence.username || presence.username === 'WayMaker AI') return;
                
                users.push({
                    name: presence.username,
                    type: presence.user_type,
                    age: presence.user_age,
                    isBot: false,
                    joinedAt: presence.online_at ? new Date(presence.online_at).getTime() / 1000 : Date.now() / 1000
                });
            });
        });
        
        this.activeUsers = users;
        this.renderUserList(users);
    }
    
    // ✅ ADDED: Enhanced user list rendering with scroll detection
    renderUserList(users) {
        if (!this.userList) return;
        
        this.userList.innerHTML = '';
        
        users.forEach(user => {
            const li = document.createElement('li');
            li.className = 'flex items-center gap-1 text-gray-300 text-xs py-0.5';
            
            if (user.isBot) {
                li.innerHTML = `
                    <div class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse"></div>
                    <span class="text-blue-300 font-medium">🤖 ${user.name}</span>
                    <span class="text-xs text-gray-500 ml-auto">AI</span>
                `;
            } else {
                const isCurrentUser = user.name === this.userInfo.name;
                const timeOnline = this.getTimeOnline(user.joinedAt);
                
                li.innerHTML = `
                    <div class="w-1.5 h-1.5 bg-green-400 rounded-full"></div>
                    <span class="${isCurrentUser ? 'text-yellow-300 font-medium' : 'text-gray-300'}">${user.name}${isCurrentUser ? ' (you)' : ''}</span>
                    <span class="text-xs text-gray-500 ml-auto">${timeOnline}</span>
                `;
            }
            
            this.userList.appendChild(li);
        });
        
        // ✅ ADDED: Detect if community list is scrollable and add visual indicator
        this.updateCommunityScrollIndicator();
        this.updateCommunityCount(users.length);
    }
    
    // ✅ ADDED: Update scroll indicator for community section
    updateCommunityScrollIndicator() {
        try {
            if (!this.userList) return;
            
            const communitySection = this.userList.closest('.community-members');
            if (!communitySection) return;
            
            // Check if content is scrollable
            const isScrollable = this.userList.scrollHeight > this.userList.clientHeight;
            
            if (isScrollable) {
                communitySection.classList.add('scrollable');
            } else {
                communitySection.classList.remove('scrollable');
            }
            
            // Add scroll position indicator
            if (isScrollable) {
                const scrollPercentage = (this.userList.scrollTop / (this.userList.scrollHeight - this.userList.clientHeight)) * 100;
                if (scrollPercentage > 10) {
                    communitySection.classList.add('scrolled');
                } else {
                    communitySection.classList.remove('scrolled');
                }
            }
        } catch (error) {
            console.error('❌ Error updating scroll indicator:', error);
        }
    }
    
    // ✅ ADDED: Auto-refresh functionality for community members
    startUserListAutoRefresh() {
        try {
            console.log('🔄 Starting community members auto-refresh (30s interval)');
            
            // Clear any existing timer
            if (this.userListRefreshTimer) {
                clearInterval(this.userListRefreshTimer);
            }
            
            // Set up 30-second refresh timer
            this.userListRefreshTimer = setInterval(() => {
                this.refreshCommunityMembers();
            }, 30000); // 30 seconds
            
            // Also refresh immediately
            this.refreshCommunityMembers();
            
            console.log('✅ Community members auto-refresh started');
        } catch (error) {
            console.error('❌ Error starting auto-refresh:', error);
        }
    }
    
    async refreshCommunityMembers() {
        try {
            console.log('🔄 Refreshing community members list...');
            
            // Show visual feedback
            this.showCommunityRefreshIndicator();
            
            if (this.presenceChannel && this.supabase) {
                // If Supabase is available, sync presence state
                try {
                    const presenceState = this.presenceChannel.presenceState();
                    this.updateUserListFromSupabase(presenceState);
                    
                    // Update online times for existing users
                    this.updateUserOnlineTimes();
                    
                    console.log('✅ Community list refreshed via Supabase');
                } catch (error) {
                    console.warn('⚠️ Supabase refresh failed, using local update:', error);
                    this.updateUserOnlineTimes();
                }
            } else {
                // Fallback: update local user list (mainly online times)
                this.updateUserOnlineTimes();
                console.log('✅ Community list refreshed locally');
            }
            
            this.lastUserListUpdate = new Date();
            
            // ✅ ADDED: Update refresh time display
            this.updateRefreshTimeDisplay();
            
            // Hide refresh indicator after a moment
            setTimeout(() => this.hideCommunityRefreshIndicator(), 1000);
            
        } catch (error) {
            console.error('❌ Error refreshing community members:', error);
        }
    }
    
    updateUserOnlineTimes() {
        try {
            // Re-render existing user list with updated times
            if (this.activeUsers && this.activeUsers.length > 0) {
                this.renderUserList(this.activeUsers);
            }
        } catch (error) {
            console.error('❌ Error updating user online times:', error);
        }
    }
    
    showCommunityRefreshIndicator() {
        try {
            const header = document.querySelector('#userList')?.parentElement?.querySelector('h3');
            if (header) {
                const originalText = header.textContent;
                header.innerHTML = `
                    <span class="flex items-center gap-1">
                        <span class="loading-spinner"></span>
                        ${originalText}
                    </span>
                `;
            }
        } catch (error) {
            console.error('❌ Error showing refresh indicator:', error);
        }
    }
    
    hideCommunityRefreshIndicator() {
        try {
            const header = document.querySelector('#userList')?.parentElement?.querySelector('h3');
            if (header) {
                const count = this.activeUsers ? this.activeUsers.length : 0;
                header.textContent = `Community Members (${count})`;
            }
        } catch (error) {
            console.error('❌ Error hiding refresh indicator:', error);
        }
    }
    
    // ✅ ADDED: Manual refresh for community members
    async manualRefreshCommunity() {
        try {
            console.log('👆 Manual community refresh triggered');
            
            // Provide immediate feedback
            if (this.manualRefreshBtn) {
                this.manualRefreshBtn.textContent = '⏳';
            }
            
            // Perform refresh
            await this.refreshCommunityMembers();
            
            // Show notification
            this.showNotification('🔄 Community list refreshed!', 'blue');
            
            // Reset button
            setTimeout(() => {
                if (this.manualRefreshBtn) {
                    this.manualRefreshBtn.textContent = '🔄';
                }
            }, 1000);
            
        } catch (error) {
            console.error('❌ Error in manual refresh:', error);
            if (this.manualRefreshBtn) {
                this.manualRefreshBtn.textContent = '🔄';
            }
        }
    }
    
    // ✅ ADDED: Update refresh time display
    updateRefreshTimeDisplay() {
        try {
            if (!this.lastRefreshTime) return;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            
            this.lastRefreshTime.textContent = `Auto-refresh: ${timeStr} (30s)`;
            this.lastRefreshTime.title = `Last refreshed at ${timeStr}. Auto-refreshes every 30 seconds.`;
            
        } catch (error) {
            console.error('❌ Error updating refresh time display:', error);
        }
    }
    
    stopUserListAutoRefresh() {
        try {
            if (this.userListRefreshTimer) {
                clearInterval(this.userListRefreshTimer);
                this.userListRefreshTimer = null;
                console.log('🛑 Community members auto-refresh stopped');
            }
        } catch (error) {
            console.error('❌ Error stopping auto-refresh:', error);
        }
    }
    
    startLocalMode() {
        console.log('🔄 Using local mode fallback...');
        const users = [
            { name: 'WayMaker AI', isBot: true, joinedAt: 0 },
            { name: this.userInfo.name, isBot: false, joinedAt: Date.now() / 1000 }
        ];
        this.activeUsers = users;
        this.renderUserList(users);
        this.showJoinNotification();
    }
    
    getTimeOnline(joinedAt) {
        if (!joinedAt || joinedAt === 0) return 'Always';
        const now = Date.now() / 1000;
        const onlineSeconds = Math.floor(now - joinedAt);
        if (onlineSeconds < 60) return 'Just joined';
        if (onlineSeconds < 3600) return `${Math.floor(onlineSeconds / 60)}m`;
        if (onlineSeconds < 86400) return `${Math.floor(onlineSeconds / 3600)}h`;
        return `${Math.floor(onlineSeconds / 86400)}d`;
    }
    
    updateCommunityCount(count) {
        try {
            const header = document.querySelector('#userList')?.parentElement?.querySelector('h3');
            if (header) {
                header.textContent = `Community Members (${count})`;
            }
        } catch (error) {
            console.error('❌ Error updating community count:', error);
        }
    }
    
    showJoinNotification() {
        this.showNotification('✅ Connected to WayMaker community!', 'green');
    }
    
    showUserJoinedNotification(userName) {
        if (userName === this.userInfo.name) return;
        this.showNotification(`🙏 ${userName} joined the community`, 'blue');
    }
    
    showUserLeftNotification(userName) {
        if (userName === this.userInfo.name) return;
        this.showNotification(`👋 ${userName} left the community`, 'gray');
    }
    
    cleanup() {
        try {
            // ✅ ADDED: Stop auto-refresh timer
            this.stopUserListAutoRefresh();
            
            // ✅ ADDED: Clean up typing indicator
            this.hideTypingSafe();
            
            if (this.presenceChannel) {
                this.presenceChannel.untrack();
                this.presenceChannel.unsubscribe();
            }
            if (this.messagesChannel) {
                this.messagesChannel.unsubscribe();
            }
        } catch (error) {
            console.error('❌ Error during cleanup:', error);
        }
    }
    
    // Enhanced Features
    
    loadHistoryCategories() {
        try {
            const saved = sessionStorage.getItem('waymaker_history_categories');
            if (saved) {
                this.historyCategories = JSON.parse(saved);
            }
        } catch (e) {
            console.log('Could not load history:', e);
        }
    }
    
    saveHistoryCategories() {
        try {
            sessionStorage.setItem('waymaker_history_categories', JSON.stringify(this.historyCategories));
        } catch (e) {
            console.log('Session storage not available:', e);
        }
    }
    
    updateHistoryDisplay() {
        const historyContainer = this.historyList;
        if (!historyContainer) return;
        
        const categories = [
            { key: 'prayer', icon: '🙏', title: 'Prayer' },
            { key: 'bible_study', icon: '📖', title: 'Bible' },
            { key: 'spiritual_guidance', icon: '💭', title: 'Guidance' },
            { key: 'community_fellowship', icon: '🤝', title: 'Fellowship' },
            { key: 'crisis_support', icon: '💪', title: 'Support' },
            { key: 'youth_family', icon: '👨‍👩‍👧‍👦', title: 'Family' }
        ];
        
        historyContainer.innerHTML = '';
        
        categories.forEach(category => {
            const items = this.historyCategories[category.key] || [];
            const latestItem = items[0];
            
            const div = document.createElement('div');
            div.className = 'history-item cursor-pointer';
            
            const count = items.length;
            const timeAgo = latestItem ? this.getTimeAgo(latestItem.timestamp) : 'None';
            const preview = latestItem ? (latestItem.preview.length > 15 ? latestItem.preview.substring(0, 15) + '...' : latestItem.preview) : 'No activity';
            
            div.innerHTML = `
                <div class="flex items-center gap-1 mb-0.5">
                    <span class="text-xs">${category.icon}</span>
                    <span class="text-xs font-medium truncate">${category.title}</span>
                </div>
                <div class="text-xs mb-0.5 text-gray-400">${count} • ${timeAgo}</div>
                <div class="text-xs truncate text-gray-300">"${preview}"</div>
            `;
            
            div.onclick = () => this.loadCategoryHistory(category.key, category.title);
            historyContainer.appendChild(div);
        });
        
        // ✅ ADDED: Check if History section is scrollable and add border
        this.updateHistoryScrollIndicator();
    }
    
    // ✅ ADDED: Update History scroll indicator 
    updateHistoryScrollIndicator() {
        try {
            const historyContent = document.querySelector('.history-content');
            const historySection = document.querySelector('.sidebar-section.fill-remaining');
            
            if (!historyContent || !historySection) return;
            
            // Check if content is scrollable
            const isScrollable = historyContent.scrollHeight > historyContent.clientHeight;
            
            if (isScrollable) {
                historySection.classList.add('scrollable');
            } else {
                historySection.classList.remove('scrollable');
            }
            
            console.log('📜 History scroll detection:', { isScrollable, scrollHeight: historyContent.scrollHeight, clientHeight: historyContent.clientHeight });
            
        } catch (error) {
            console.error('❌ Error updating History scroll indicator:', error);
        }
    }
    
    getTimeAgo(timestamp) {
        if (!timestamp) return 'Unknown';
        try {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return past.toLocaleDateString();
        } catch (e) {
            return 'Recently';
        }
    }
    
    // ✅ FIXED: Enhanced History category loading with better UX
    loadCategoryHistory(categoryKey, categoryTitle) {
        const items = this.historyCategories[categoryKey] || [];
        if (items.length === 0) {
            this.showNotification(`📜 No ${categoryTitle.toLowerCase()} history yet.`, 'gray');
            return;
        }
        
        // Create a selection interface instead of alert
        this.showHistorySelectionModal(items, categoryTitle);
    }
    
    // ✅ ADDED: History selection modal for better UX
    showHistorySelectionModal(items, categoryTitle) {
        try {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'historyModal';
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-gray-800 border border-gray-600 rounded-lg p-4 max-w-2xl w-full max-h-96 mx-4';
            
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-white font-semibold">📜 ${categoryTitle} History</h3>
                    <button id="closeHistoryModal" class="text-gray-400 hover:text-white text-xl font-bold">×</button>
                </div>
                <div class="text-xs text-gray-400 mb-3">Click any item to load it into your chat input:</div>
                <div class="space-y-2 max-h-64 overflow-y-auto" id="historyItems">
                    ${items.map((item, index) => `
                        <div class="history-select-item bg-gray-700 hover:bg-gray-600 p-3 rounded cursor-pointer transition-colors" data-index="${index}">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-xs text-gray-400">#${index + 1}</span>
                                <span class="text-xs text-gray-500">${this.getTimeAgo(item.timestamp)}</span>
                            </div>
                            <div class="text-sm text-gray-200">${item.preview.length > 100 ? item.preview.substring(0, 100) + '...' : item.preview}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-4 flex justify-end gap-2">
                    <button id="cancelHistoryModal" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded text-sm">Cancel</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('closeHistoryModal').onclick = () => this.closeHistoryModal();
            document.getElementById('cancelHistoryModal').onclick = () => this.closeHistoryModal();
            
            // Add click listeners to history items
            document.querySelectorAll('.history-select-item').forEach(item => {
                item.onclick = () => {
                    const index = parseInt(item.dataset.index);
                    this.loadHistoryItemToInput(items[index]);
                    this.closeHistoryModal();
                };
            });
            
            // Close on background click
            modal.onclick = (e) => {
                if (e.target === modal) this.closeHistoryModal();
            };
            
        } catch (error) {
            console.error('❌ Error showing history selection modal:', error);
        }
    }
    
    // ✅ FIXED: Load history item as message in chat instead of input
    loadHistoryItemToInput(historyItem) {
        try {
            // Add the history item as a message in the chat
            const historyMessage = `📜 **History Loaded**: ${historyItem.type}\n\n${historyItem.preview}\n\n*Originally from: ${this.getTimeAgo(historyItem.timestamp)}*`;
            
            this.addMessageToUI(historyMessage, 'user', this.userInfo.name);
            
            // Also broadcast to other users
            this.broadcastMessage(historyMessage, 'user', this.userInfo.name);
            
            this.showNotification(`📜 History loaded: "${historyItem.type}"`, 'blue');
            
            // Add to current session history
            this.addToHistory('History Recall', historyItem.preview, '📜');
            
        } catch (error) {
            console.error('❌ Error loading history item to chat:', error);
        }
    }
    
    // ✅ ADDED: Close history modal
    closeHistoryModal() {
        try {
            const modal = document.getElementById('historyModal');
            if (modal) {
                modal.remove();
            }
        } catch (error) {
            console.error('❌ Error closing history modal:', error);
        }
    }
    
    addToHistory(type, preview, icon = '💬') {
        const historyItem = {
            type: type, preview: preview, icon: icon,
            timestamp: new Date().toISOString()
        };
        
        let category = 'spiritual_guidance';
        if (type === 'Prayer Request' || type.toLowerCase().includes('prayer') || preview.toLowerCase().includes('pray')) {
            category = 'prayer';
        } else if (type === 'Bible Study' || type.toLowerCase().includes('verse') || type.toLowerCase().includes('biblical') || preview.toLowerCase().includes('bible')) {
            category = 'bible_study';
        } else if (preview.toLowerCase().includes('crisis') || preview.toLowerCase().includes('help') || preview.toLowerCase().includes('emergency')) {
            category = 'crisis_support';
        } else if (preview.toLowerCase().includes('family') || preview.toLowerCase().includes('children') || preview.toLowerCase().includes('youth')) {
            category = 'youth_family';
        } else if (preview.toLowerCase().includes('community') || preview.toLowerCase().includes('fellowship') || preview.toLowerCase().includes('church')) {
            category = 'community_fellowship';
        }
        
        this.historyCategories[category].unshift(historyItem);
        if (this.historyCategories[category].length > 10) {
            this.historyCategories[category] = this.historyCategories[category].slice(0, 10);
        }
        
        this.saveHistoryCategories();
        this.updateHistoryDisplay();
    }
    
    addWelcomeMessage() {
        try {
            console.log('👋 Adding welcome message...');
            
            const welcome = `Peace be with you, ${this.userInfo.name}! 👋\n\nWelcome to WayMaker AI Community Chat - your place for real-time biblical guidance and spiritual fellowship.\n\nThis is a live group chat where our growing faith community shares wisdom, prayer requests, and spiritual encouragement together. WayMaker AI is here to provide biblical insights when you need guidance.\n\n"For where two or three gather in my name, there am I with them." - Matthew 18:20 NIV\n\nShare your spiritual journey with us - we're here to walk alongside you! 🙏`;
            
            this.addMessageToUI(welcome, 'assistant', 'WayMaker AI', true);
            console.log('✅ Welcome message added successfully');
        } catch (error) {
            console.error('❌ Error adding welcome message:', error);
        }
    }
    
    async sendMessage() {
        try {
            const message = this.messageInput?.value?.trim();
            if (!message) return;
            
            // Check if we're in edit mode
            if (this.editingMessageId) {
                this.saveMessageEdit(message);
                return;
            }
            
            this.addMessageToUI(message, 'user', this.userInfo.name);
            await this.broadcastMessage(message, 'user', this.userInfo.name);
            
            this.messageInput.value = '';
            
            const lowerMessage = message.toLowerCase();
            let historyType = 'Message';
            let historyIcon = '💬';
            
            if (lowerMessage.includes('bible') || lowerMessage.includes('scripture') || lowerMessage.includes('verse')) {
                historyType = 'Bible Study';
                historyIcon = '📖';
            } else if (lowerMessage.includes('prayer') || lowerMessage.includes('pray')) {
                historyType = 'Prayer Request';
                historyIcon = '🙏';
            }
            
            this.addToHistory(historyType, message, historyIcon);
            
            if (this.shouldWayMakerRespond(message)) {
                // ✅ FIXED: Enhanced typing indicator with timeout safety
                this.showTypingWithTimeout();
                
                try {
                    const response = await this.callDifyAPI(message);
                    this.hideTypingSafe();
                    
                    if (response && response !== '(silence)') {
                        this.addMessageToUI(response, 'assistant', 'WayMaker AI', true);
                        await this.broadcastMessage(response, 'assistant', 'WayMaker AI', true);
                        this.updateApiStatus('connected', 'Response received');
                    } else {
                        const fallback = this.getFallbackResponse(message);
                        if (fallback !== '(silence)') {
                            this.addMessageToUI(fallback, 'assistant', 'WayMaker AI', true);
                            await this.broadcastMessage(fallback, 'assistant', 'WayMaker AI', true);
                            this.updateApiStatus('fallback', 'Using fallback response');
                        }
                    }
                } catch (error) {
                    this.hideTypingSafe();
                    console.error('❌ Dify API Error:', error);
                    const fallback = this.getFallbackResponse(message);
                    if (fallback !== '(silence)') {
                        this.addMessageToUI(fallback, 'assistant', 'WayMaker AI', true);
                        await this.broadcastMessage(fallback, 'assistant', 'WayMaker AI', true);
                    }
                    this.updateApiStatus('fallback', 'API error - using fallback');
                }
            }
        } catch (error) {
            console.error('❌ Error sending message:', error);
        }
    }
    
    shouldWayMakerRespond(message) {
        const lowerMessage = message.toLowerCase();
        
        return lowerMessage.includes('waymaker') ||
               lowerMessage.includes('bible') || lowerMessage.includes('scripture') || lowerMessage.includes('verse') ||
               lowerMessage.includes('prayer') || lowerMessage.includes('pray') ||
               lowerMessage.includes('jesus') || lowerMessage.includes('god') || lowerMessage.includes('faith') ||
               lowerMessage.includes('guidance') || lowerMessage.includes('help') ||
               lowerMessage.includes('wisdom') || lowerMessage.includes('spiritual');
    }
    
    async callDifyAPI(message, retryCount = 0) {
        const lowerMessage = message.toLowerCase();
        let spiritual_context = 'group discussion';
        let crisis_level = 'none';
        
        if (lowerMessage.includes('doubt') || lowerMessage.includes('losing faith')) {
            spiritual_context = 'faith crisis';
            crisis_level = 'serious';
        } else if (lowerMessage.includes('death') || lowerMessage.includes('grief')) {
            spiritual_context = 'grief and loss';
            crisis_level = 'serious';
        } else if (lowerMessage.includes('prayer')) {
            spiritual_context = 'prayer support';
        } else if (lowerMessage.includes('bible')) {
            spiritual_context = 'biblical study';
        } else if (lowerMessage.includes('struggling')) {
            spiritual_context = 'personal struggle';
            crisis_level = 'mild';
        }
        
        // Simplified payload with ONLY the 4 variables Dify expects
const payload = {
    inputs: {
        user_name: this.userInfo.name,
        user_age: this.userInfo.age,
        topic: message, // Keep full message without truncation
        registration_type: this.userInfo.type
    },
    query: message,
    response_mode: 'blocking',
    user: this.userInfo.name
};
        
        if (this.conversationId) {
            payload.conversation_id = this.conversationId;
        }
        
        try {
            const response = await fetch(this.apiUrl, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + this.apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                if (response.status === 404 && retryCount < 3) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return this.callDifyAPI(message, retryCount + 1);
                }
                throw new Error(`API call failed: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.conversation_id) {
                this.conversationId = data.conversation_id;
            }
            
            if (data.message_id) {
                this.currentMessageId = data.message_id;
            }
            
            const apiResponse = data.answer || data.data?.answer || data.message;
            if (apiResponse && apiResponse.trim() && apiResponse !== '(silence)') {
                this.lastApiSuccess = new Date();
                return apiResponse;
            } else {
                throw new Error('No valid API response received');
            }
            
        } catch (fetchError) {
            if (retryCount < 3) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                return this.callDifyAPI(message, retryCount + 1);
            }
            throw fetchError;
        }
    }
    
    getFallbackResponse(message) {
        const lowerMessage = message.toLowerCase();
        let fallback = `Peace be with you, ${this.userInfo.name}! `;
        
        if (lowerMessage.includes('waymaker') || lowerMessage.includes('help')) {
            fallback += 'I\'m here to help our community grow in faith. "Ask and it will be given to you; seek and you will find; knock and the door will be opened to you." - Matthew 7:7 NIV\n\nI\'m currently having some connection issues with our enhanced API. Please try again or check our connection status in the sidebar.';
            return fallback;
        }
        
        if (!lowerMessage.includes('god') && !lowerMessage.includes('jesus') && 
            !lowerMessage.includes('faith') && !lowerMessage.includes('waymaker') &&
            !lowerMessage.includes('prayer') && !lowerMessage.includes('bible')) {
            return '(silence)';
        }
        
        fallback += 'I\'m here to provide biblical guidance for our community. While I\'m experiencing some technical difficulties with our live API, I can still offer biblical encouragement. Please try again, and I\'ll do my best to help with God\'s wisdom. 🙏';
        return fallback;
    }
    
    addMessageToUI(content, type, sender, shouldStream = false) {
        if (content === '(silence)') return;
        
        try {
            const messageDiv = document.createElement('div');
            const messageId = 'msg_' + (++this.messageCounter);
            messageDiv.id = messageId;
            messageDiv.className = 'message group';
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const isUser = type === 'user';
            const isCurrentUser = sender === this.userInfo.name;
            const isAssistant = type === 'assistant';
            
            // ✅ ADDED: Action icons for all messages (with suggest icon more prominent)
            const actionIcons = `
                <div class="message-action-icons flex gap-1 mb-2 opacity-100 transition-opacity duration-200">
                    ${isAssistant ? '<button class="action-icon suggest-icon" onclick="chat.suggestFollowUp(\'' + messageId + '\')" title="Get biblical follow-up suggestions">💡</button>' : ''}
                    ${isCurrentUser ? '<button class="action-icon" onclick="chat.startEditMessage(\'' + messageId + '\')" title="Edit message">✏️</button>' : ''}
                    <button class="action-icon" onclick="chat.rateMessage(\'' + messageId + '\', \'up\')" title="Rate helpful">👍</button>
                    <button class="action-icon" onclick="chat.rateMessage(\'' + messageId + '\', \'down\')" title="Rate unhelpful">👎</button>
                    <button class="action-icon" onclick="chat.textToSpeech(\'' + messageId + '\')" title="Text to speech">🔊</button>
                    <button class="action-icon" onclick="chat.voiceReply(\'' + messageId + '\')" title="Voice reply">🎤</button>
                    ${isCurrentUser ? '<button class="action-icon" onclick="chat.deleteMessage(\'' + messageId + '\')" title="Delete message">🗑️</button>' : ''}
                </div>
            `;
            
            // Enhanced message with action icons and edit/delete functionality
            messageDiv.innerHTML = 
                '<div class="flex ' + (isCurrentUser ? 'justify-end' : 'justify-start') + '">' +
                    '<div class="max-w-2xl">' +
                        '<div class="flex justify-between items-center mb-1 text-xs text-gray-400">' +
                            '<strong class="text-' + (isUser ? (isCurrentUser ? 'yellow' : 'blue') : 'green') + '-400">' + sender + (isCurrentUser ? ' (you)' : '') + '</strong>' +
                            '<span>' + time + '</span>' +
                        '</div>' +
                        actionIcons +
                        '<div class="message-content compact-message p-2 rounded-xl whitespace-pre-wrap ' + 
                            (isUser ? (isCurrentUser ? 'bg-blue-600 text-white' : 'bg-purple-600 text-white') : 'bg-gray-800 text-gray-100 border border-gray-700') + '">' +
                            (shouldStream ? '' : content) +
                        '</div>' +
                    '</div>' +
                '</div>';
            
            if (this.messagesContainer) {
                this.messagesContainer.appendChild(messageDiv);
                // ✅ FIXED: Improved auto-scroll with proper timing
                this.scrollToBottom();
            }
            
            if (shouldStream && type === 'assistant') {
                this.typeMessage(messageId, content);
            }
            
            return messageId;
        } catch (error) {
            console.error('❌ Error adding message to UI:', error);
        }
    }

    // ✅ ADDED: Scroll detection handler
    handleScroll() {
        try {
            if (!this.messagesContainer || !this.scrollToBottomBtn) return;
            
            const { scrollTop, scrollHeight, clientHeight } = this.messagesContainer;
            const isNearBottom = scrollTop + clientHeight >= scrollHeight - 100;
            
            // Show/hide scroll-to-bottom button based on scroll position
            if (isNearBottom) {
                this.scrollToBottomBtn.classList.remove('visible');
            } else {
                this.scrollToBottomBtn.classList.add('visible');
            }
        } catch (error) {
            console.error('❌ Error handling scroll:', error);
        }
    }

    // ✅ FIXED: Enhanced scrolling functionality
    scrollToBottom(force = false) {
        try {
            if (!this.messagesContainer) return;
            
            // Check if user has scrolled up and don't auto-scroll unless forced
            const { scrollTop, scrollHeight, clientHeight } = this.messagesContainer;
            const isNearBottom = scrollTop + clientHeight >= scrollHeight - 100;
            
            // Only auto-scroll if user is near bottom or if forced
            if (isNearBottom || force || this.settings?.autoScroll !== false) {
                // Use requestAnimationFrame for smooth scrolling
                requestAnimationFrame(() => {
                    if (this.messagesContainer) {
                        this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                    }
                });
            }
        } catch (error) {
            console.error('❌ Error scrolling to bottom:', error);
        }
    }
    
    // ✅ FIXED: Manual scroll to bottom function
    forceScrollToBottom() {
        this.scrollToBottom(true);
    }

    
    // ✅ ADDED: New message action functions
    
    suggestFollowUp(messageId) {
        try {
            const messageEl = document.getElementById(messageId);
            const contentEl = messageEl?.querySelector('.message-content');
            
            if (!messageEl || !contentEl) return;
            
            // Check if suggestions are already shown
            const existingSuggestions = messageEl.querySelector('.suggestions-container');
            if (existingSuggestions) {
                existingSuggestions.remove();
                this.showNotification("💡 Suggestions hidden", 'gray');
                return;
            }
            
            const suggestions = [
                "Can you elaborate on that biblical principle?",
                "What other scriptures relate to this topic?", 
                "How can I apply this to my daily life?",
                "What would Jesus do in this situation?",
                "Can you share a prayer about this?",
                "Are there any biblical examples of this?",
                "Can you explain this in simpler terms?",
                "What does this mean for my daily walk with God?"
            ];
            
            // Create suggestions container
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'suggestions-container mt-3 p-3 bg-blue-900/20 border border-blue-400/30 rounded-lg';
            
            suggestionsContainer.innerHTML = `
                <div class="text-xs text-blue-300 mb-2 font-semibold flex items-center gap-1">
                    💡 Suggested follow-up questions:
                </div>
                <div class="space-y-1">
                    ${suggestions.map((suggestion, index) => `
                        <div class="suggestion-item text-sm text-blue-200 hover:text-white cursor-pointer p-2 rounded hover:bg-blue-800/30 transition-colors"
                             data-suggestion="${suggestion}" data-message-id="${messageId}">
                            ${index + 1}. ${suggestion}
                        </div>
                    `).join('')}
                </div>
                <div class="text-xs text-blue-400 mt-2 opacity-75">
                    Click any suggestion to add it to your input box
                </div>
            `;
            
            // Insert suggestions after the message content
            const messageWrapper = messageEl.querySelector('.max-w-2xl');
            if (messageWrapper) {
                messageWrapper.appendChild(suggestionsContainer);
            }
            
            // Add click listeners to suggestions
            suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
                item.onclick = () => {
                    const suggestion = item.dataset.suggestion;
                    if (this.messageInput) {
                        this.messageInput.value = suggestion;
                        this.messageInput.focus();
                        this.messageInput.setSelectionRange(suggestion.length, suggestion.length);
                    }
                    
                    // Remove suggestions after selection
                    suggestionsContainer.remove();
                    
                    this.showNotification(`💡 Added: "${suggestion.substring(0, 30)}..."`, 'blue');
                };
            });
            
            // Auto-scroll to show suggestions
            this.scrollToBottom();
            
            this.showNotification("💡 Biblical follow-up suggestions shown below", 'blue');
            
        } catch (error) {
            console.error('❌ Error suggesting follow-up:', error);
        }
    }
    
    rateMessage(messageId, rating) {
        try {
            const messageEl = document.getElementById(messageId);
            if (!messageEl) return;
            
            // Visual feedback
            const rateButtons = messageEl.querySelectorAll('.action-icon:nth-child(3), .action-icon:nth-child(4)');
            rateButtons.forEach(btn => btn.style.opacity = '0.5');
            
            if (rating === 'up') {
                const upButton = messageEl.querySelector('.action-icon:nth-child(3)');
                if (upButton) {
                    upButton.style.opacity = '1';
                    upButton.style.background = '#10b981';
                }
                this.showNotification("👍 Message rated as helpful", 'green');
            } else {
                const downButton = messageEl.querySelector('.action-icon:nth-child(4)');
                if (downButton) {
                    downButton.style.opacity = '1';
                    downButton.style.background = '#ef4444';
                }
                this.showNotification("👎 Message rated as unhelpful", 'red');
            }
            
            // Add to history
            this.addToHistory('Message Rating', `Rated message: ${rating}`, rating === 'up' ? '👍' : '👎');
            
        } catch (error) {
            console.error('❌ Error rating message:', error);
        }
    }
    
    textToSpeech(messageId) {
        try {
            const messageEl = document.getElementById(messageId);
            const contentEl = messageEl?.querySelector('.message-content');
            const content = contentEl?.textContent || '';
            
            if ('speechSynthesis' in window && content) {
                const utterance = new SpeechSynthesisUtterance(content);
                utterance.rate = 0.8;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                
                // Find a suitable voice
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.lang.startsWith('en') && (voice.name.includes('Female') || voice.name.includes('Google'))
                );
                if (preferredVoice) utterance.voice = preferredVoice;
                
                speechSynthesis.speak(utterance);
                
                this.showNotification("🔊 Speaking message...", 'purple');
                
                // Visual feedback
                const ttsButton = messageEl.querySelector('.action-icon:nth-child(5)');
                if (ttsButton) {
                    ttsButton.style.background = '#8b5cf6';
                    setTimeout(() => {
                        ttsButton.style.background = '';
                    }, 3000);
                }
            } else {
                this.showNotification("🔊 Text-to-speech not available", 'gray');
            }
        } catch (error) {
            console.error('❌ Error with text-to-speech:', error);
            this.showNotification("❌ Text-to-speech error", 'red');
        }
    }
    
    voiceReply(messageId) {
        try {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onstart = () => {
                    this.showNotification("🎤 Listening... Speak your reply", 'cyan');
                    
                    // Visual feedback
                    const voiceButton = messageEl?.querySelector('.action-icon:nth-child(6)');
                    if (voiceButton) {
                        voiceButton.style.background = '#ef4444';
                        voiceButton.textContent = '⏹️';
                    }
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    if (this.messageInput) {
                        this.messageInput.value = transcript;
                        this.messageInput.focus();
                    }
                    this.showNotification(`🎤 Voice captured: "${transcript.substring(0, 30)}..."`, 'cyan');
                };
                
                recognition.onend = () => {
                    // Reset button
                    const voiceButton = document.getElementById(messageId)?.querySelector('.action-icon:nth-child(6)');
                    if (voiceButton) {
                        voiceButton.style.background = '';
                        voiceButton.textContent = '🎤';
                    }
                };
                
                recognition.onerror = () => {
                    this.showNotification("❌ Voice recognition error", 'red');
                };
                
                recognition.start();
            } else {
                this.showNotification("🎤 Voice recognition not available", 'gray');
            }
        } catch (error) {
            console.error('❌ Error with voice reply:', error);
            this.showNotification("❌ Voice reply error", 'red');
        }
    }

    // Enhanced Message Edit/Delete Functionality
    startEditMessage(messageId) {
        try {
            if (this.editingMessageId) {
                this.cancelMessageEdit();
            }
            
            const messageEl = document.getElementById(messageId);
            const contentEl = messageEl?.querySelector('.message-content');
            
            if (!messageEl || !contentEl) return;
            
            // Store original content
            this.originalMessageContent = contentEl.textContent;
            this.editingMessageId = messageId;
            
            // Add edit mode styling
            messageEl.classList.add('edit-mode');
            
            // Replace content with input
            contentEl.innerHTML = `
                <textarea class="w-full bg-gray-600 text-white p-2 rounded border border-blue-400 resize-none" 
                          rows="3" id="editInput">${this.originalMessageContent}</textarea>
                <div class="edit-controls">
                    <button class="action-button" onclick="chat.saveMessageEdit()">💾 Save</button>
                    <button class="action-button" onclick="chat.cancelMessageEdit()">❌ Cancel</button>
                </div>
            `;
            
            // Focus the input
            const editInput = document.getElementById('editInput');
            if (editInput) {
                editInput.focus();
                editInput.setSelectionRange(editInput.value.length, editInput.value.length);
            }
            
            // Update message input behavior
            if (this.messageInput) {
                this.messageInput.placeholder = "Click Save to confirm edit, or Cancel to revert...";
            }
            if (this.sendButton) {
                this.sendButton.textContent = "Save Edit";
            }
        } catch (error) {
            console.error('❌ Error starting message edit:', error);
        }
    }
    
    saveMessageEdit(newContent = null) {
        try {
            if (!this.editingMessageId) return;
            
            const messageEl = document.getElementById(this.editingMessageId);
            const editInput = document.getElementById('editInput');
            const contentEl = messageEl?.querySelector('.message-content');
            
            if (!messageEl || !contentEl) return;
            
            const updatedContent = newContent || editInput?.value || this.messageInput?.value;
            
            if (!updatedContent?.trim()) {
                alert('Message cannot be empty!');
                return;
            }
            
            // Update the message content
            contentEl.innerHTML = updatedContent;
            
            // Remove edit mode
            messageEl.classList.remove('edit-mode');
            
            // Reset editing state
            this.editingMessageId = null;
            this.originalMessageContent = '';
            if (this.messageInput) {
                this.messageInput.placeholder = "Share with community, ask questions, or request prayer...";
                this.messageInput.value = '';
            }
            if (this.sendButton) {
                this.sendButton.textContent = "Send";
            }
            
            // Show notification
            this.showNotification('✅ Message updated successfully!', 'green');
            
            // Add to history
            this.addToHistory('Message Edit', updatedContent, '✏️');
        } catch (error) {
            console.error('❌ Error saving message edit:', error);
        }
    }
    
    cancelMessageEdit() {
        try {
            if (!this.editingMessageId) return;
            
            const messageEl = document.getElementById(this.editingMessageId);
            const contentEl = messageEl?.querySelector('.message-content');
            
            if (!messageEl || !contentEl) return;
            
            // Restore original content
            contentEl.innerHTML = this.originalMessageContent;
            
            // Remove edit mode
            messageEl.classList.remove('edit-mode');
            
            // Reset editing state
            this.editingMessageId = null;
            this.originalMessageContent = '';
            if (this.messageInput) {
                this.messageInput.placeholder = "Share with community, ask questions, or request prayer...";
                this.messageInput.value = '';
            }
            if (this.sendButton) {
                this.sendButton.textContent = "Send";
            }
            
            // Show notification
            this.showNotification('↩️ Edit cancelled', 'gray');
        } catch (error) {
            console.error('❌ Error cancelling message edit:', error);
        }
    }
    
    deleteMessage(messageId) {
        try {
            const messageEl = document.getElementById(messageId);
            const contentEl = messageEl?.querySelector('.message-content');
            
            if (!messageEl || !contentEl) return;
            
            const messageContent = contentEl.textContent;
            
            if (confirm(`Delete this message?\n\n"${messageContent.substring(0, 100)}${messageContent.length > 100 ? '...' : ''}"`)) {
                // Add deleted indicator
                contentEl.innerHTML = '<em class="text-gray-500">This message was deleted</em>';
                contentEl.className = contentEl.className.replace(/bg-\w+-\d+/, 'bg-gray-600');
                
                // Remove action buttons
                const actionsEl = messageEl.querySelector('.message-actions');
                if (actionsEl) actionsEl.remove();
                
                // Show notification
                this.showNotification('🗑️ Message deleted', 'red');
                
                // Add to history
                this.addToHistory('Message Deletion', messageContent.substring(0, 50), '🗑️');
            }
        } catch (error) {
            console.error('❌ Error deleting message:', error);
        }
    }
    
    showNotification(message, color = 'blue') {
        try {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 bg-${color}-600 text-white px-3 py-2 rounded-lg shadow-lg z-50 text-sm`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        } catch (error) {
            console.error('❌ Error showing notification:', error);
        }
    }
    
    async typeMessage(messageId, fullText) {
        try {
            const messageElement = document.getElementById(messageId);
            const contentDiv = messageElement?.querySelector('.message-content');
            
            if (!contentDiv) return;
            
            contentDiv.innerHTML = '<span class="typing-cursor">▊</span>';
            
            let displayedText = '';
            const words = fullText.split(' ');
            
            const baseDelay = 25;
            const wordDelay = 80;
            const punctuationDelay = 150;
            
            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                displayedText += (i > 0 ? ' ' : '') + word;
                
                contentDiv.innerHTML = displayedText + '<span class="typing-cursor animate-pulse">▊</span>';
                // ✅ FIXED: Improved scroll timing during typing
                this.scrollToBottom();
                
                let delay = baseDelay * word.length + wordDelay;
                
                if (word.includes('.') || word.includes('!') || word.includes('?') || word.includes(':')) {
                    delay += punctuationDelay;
                }
                
                if (word.match(/\d+:\d+/) || word.includes('NIV') || word.includes('ESV')) {
                    delay += punctuationDelay;
                }
                
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            
            contentDiv.innerHTML = displayedText;
            
            // ✅ ADDED: Ensure typing indicator is hidden when message completes
            this.hideTypingSafe();
            
            contentDiv.style.transform = 'scale(1.01)';
            setTimeout(() => {
                contentDiv.style.transform = 'scale(1)';
                contentDiv.style.transition = 'transform 0.2s ease';
            }, 200);
        } catch (error) {
            console.error('❌ Error typing message:', error);
        }
    }
    
    // ✅ FIXED: Enhanced typing indicator with timeout safety
    showTypingWithTimeout() {
        try {
            // Clear any existing typing indicator first
            this.hideTypingSafe();
            
            console.log('🔄 Showing typing indicator...');
            
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing';
            typingDiv.className = 'flex justify-start message';
            typingDiv.innerHTML = 
                '<div class="max-w-2xl">' +
                    '<div class="flex justify-between items-center mb-1 text-xs text-gray-400">' +
                        '<strong class="text-green-400">WayMaker AI</strong>' +
                        '<span>' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + '</span>' +
                    '</div>' +
                    '<div class="message-content p-2 bg-gray-800 text-gray-100 border border-gray-700 rounded-xl">' +
                        '<div class="flex items-center gap-2 text-gray-400 italic text-sm">' +
                            '<div class="flex gap-1">' +
                                '<div class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce"></div>' +
                                '<div class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>' +
                                '<div class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>' +
                            '</div>' +
                            '<span>WayMaker AI is reflecting on your message...</span>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            
            if (this.messagesContainer) {
                this.messagesContainer.appendChild(typingDiv);
                this.scrollToBottom();
                this.isTypingShown = true;
                
                // Set timeout safety - auto-hide after 30 seconds
                this.typingTimer = setTimeout(() => {
                    console.log('⏰ Typing indicator timeout - auto-hiding');
                    this.hideTypingSafe();
                }, 30000);
                
                console.log('✅ Typing indicator shown successfully');
            }
        } catch (error) {
            console.error('❌ Error showing typing indicator:', error);
            this.isTypingShown = false;
        }
    }
    
    // ✅ FIXED: Safe typing indicator hiding with proper cleanup
    hideTypingSafe() {
        try {
            if (!this.isTypingShown) {
                return; // Already hidden
            }
            
            console.log('🛑 Hiding typing indicator...');
            
            // Clear timeout
            if (this.typingTimer) {
                clearTimeout(this.typingTimer);
                this.typingTimer = null;
            }
            
            // Remove typing div
            const typingDiv = document.getElementById('typing');
            if (typingDiv) {
                typingDiv.remove();
                console.log('✅ Typing indicator removed successfully');
            }
            
            this.isTypingShown = false;
        } catch (error) {
            console.error('❌ Error hiding typing indicator:', error);
        }
    }
    
    // ✅ LEGACY: Keep old methods for compatibility
    showTyping() {
        this.showTypingWithTimeout();
    }
    
    hideTyping() {
        this.hideTypingSafe();
    }
    
    // Enhanced Feature Handlers
    
    clearChat() {
        if (confirm('Clear all messages from this chat session?\n\nThis will only clear your local view - other community members will still see their messages.')) {
            if (this.messagesContainer) {
                this.messagesContainer.innerHTML = '';
            }
            this.messageCounter = 0;
            this.addWelcomeMessage();
            this.showNotification('🗑️ Chat cleared locally', 'gray');
        }
    }
    
    startVoiceInput() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = this.userInfo.language === 'Spanish' ? 'es-ES' : 'en-US';
            
            recognition.onstart = () => {
                if (this.voiceBtn) {
                    this.voiceBtn.textContent = '🛑';
                    this.voiceBtn.style.backgroundColor = '#ef4444';
                }
            };
            
            recognition.onresult = (event) => {
                if (this.messageInput) {
                    this.messageInput.value = event.results[0][0].transcript;
                    this.messageInput.focus();
                }
            };
            
            recognition.onend = () => {
                if (this.voiceBtn) {
                    this.voiceBtn.textContent = '🎤';
                    this.voiceBtn.style.backgroundColor = '';
                }
            };
            
            recognition.start();
        } else {
            alert('Voice input not supported in this browser');
        }
    }
    
    handleFileUpload(event) {
        const files = event.target.files;
        if (!files.length) return;
        
        for (const file of files) {
            const message = '📁 Shared file with community: ' + file.name + '\n\nWayMaker AI, please provide biblical insights on this file for our group.';
            this.addMessageToUI(message, 'user', this.userInfo.name);
            this.broadcastMessage(message, 'user', this.userInfo.name);
            
            this.addToHistory('File Upload', file.name, '📁');
            
            setTimeout(() => {
                const response = `Thank you, ${this.userInfo.name}, for sharing "${file.name}" with our community.\n\n"Your word is a lamp for my feet, a light on my path." - Psalm 119:105 NIV\n\nPlease share what specific aspects you'd like our community to explore from a biblical perspective.`;
                this.addMessageToUI(response, 'assistant', 'WayMaker AI', true);
                this.broadcastMessage(response, 'assistant', 'WayMaker AI', true);
            }, 1000);
        }
        
        event.target.value = '';
    }
    
    handlePrayerRequest() {
        const prayer = prompt('Share your prayer request with the community:');
        if (prayer && prayer.trim()) {
            const message = '🙏 Prayer Request for Community: ' + prayer + '\n\nWayMaker AI, please provide biblical encouragement for this prayer request.';
            this.addMessageToUI(message, 'user', this.userInfo.name);
            this.broadcastMessage(message, 'user', this.userInfo.name);
            
            this.addToHistory('Prayer Request', prayer, '🙏');
            
            setTimeout(() => {
                const response = `Let us pray together for ${this.userInfo.name}:\n\n"Heavenly Father, we lift up this prayer request: ${prayer}\n\nLord, we ask for Your peace and guidance. Help us trust Your perfect timing.\n\n'And we know that in all things God works for the good of those who love him.' - Romans 8:28 NIV\n\nOur community stands with you in prayer. 🙏❤️"`;
                this.addMessageToUI(response, 'assistant', 'WayMaker AI', true);
                this.broadcastMessage(response, 'assistant', 'WayMaker AI', true);
            }, 1000);
        }
    }
    
    handleVerseLookup() {
        const verse = prompt('Enter a Bible verse reference to share with the community (e.g., John 3:16):');
        if (verse && verse.trim()) {
            const message = '📖 Bible Study for Community: Please explain ' + verse + ' with biblical context and application.';
            this.addMessageToUI(message, 'user', this.userInfo.name);
            this.broadcastMessage(message, 'user', this.userInfo.name);
            
            this.addToHistory('Bible Study', verse, '📖');
            
            setTimeout(() => {
                const response = `Here's guidance on ${verse} for our community:\n\nFor the exact text, please consult your Bible. I can share biblical wisdom on this topic:\n\n"All Scripture is God-breathed and useful for teaching." - 2 Timothy 3:16 NIV\n\nHow would our community like to explore the themes from this passage together?`;
                this.addMessageToUI(response, 'assistant', 'WayMaker AI', true);
                this.broadcastMessage(response, 'assistant', 'WayMaker AI', true);
            }, 1000);
        }
    }
    
    exportConversation() {
        try {
            const messages = [];
            const messageElements = this.messagesContainer?.querySelectorAll('.message');
            
            if (messageElements) {
                messageElements.forEach(el => {
                    if (el.id === 'typing') return;
                    
                    const sender = el.querySelector('strong')?.textContent || 'Unknown';
                    const content = el.querySelector('.message-content')?.textContent || '';
                    const timestamp = el.querySelector('span')?.textContent || '';
                    
                    messages.push('[' + timestamp + '] ' + sender + ': ' + content);
                });
            }
            
            const sessionInfo = `Enhanced Group Chat Export\nUser: ${this.userInfo.name}\nAge: ${this.userInfo.age}\nType: ${this.userInfo.type}\nAccess: ${this.userInfo.access}\nLanguage: ${this.userInfo.language}`;
            
            const exportText = `WayMaker AI Enhanced Group Chat Export\n${'='.repeat(50)}\nExported: ${new Date().toLocaleString()}\n\n${sessionInfo}\n\n${'='.repeat(50)}\n\n${messages.join('\n\n')}`;
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `waymaker-enhanced-chat-${this.userInfo.name}-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (error) {
            console.error('❌ Error exporting conversation:', error);
        }
    }
    
    startNewSession() {
        if (confirm('Start a new session? This will return you to the welcome page and end your group chat participation.')) {
            window.location.href = 'auth.html';
        }
    }
    
    exitChat() {
        const userName = this.userInfo.name;
        
        const exitMessage = `${userName}, are you sure you want to exit the WayMaker AI enhanced group chat?\n\n` +
                          `You'll leave the community discussion and session data will be cleared.\n` +
                          `You can always return anytime - just visit our welcome page again!\n\n` +
                          `"The Lord your God will be with you wherever you go." - Joshua 1:9`;
        
        if (confirm(exitMessage)) {
            this.cleanup();
            window.location.href = 'index.html';
        }
    }
    
    // ✨ SETTINGS PANEL FUNCTIONALITY ✨
    
    // Settings Management
    loadSettings() {
        try {
            const saved = localStorage.getItem('waymaker_settings');
            const defaults = {
                fontSize: 'medium',
                theme: 'dark',
                soundNotifications: true,
                joinLeaveNotifications: true,
                typingIndicator: true,
                enterToSend: true,
                timestampDisplay: true,
                compactMode: false,
                autoScroll: true,
                saveHistory: true,
                shareAnalytics: false
            };
            
            this.settings = saved ? { ...defaults, ...JSON.parse(saved) } : defaults;
            this.applySettings();
        } catch (error) {
            console.error('❌ Error loading settings:', error);
            this.resetToDefaults();
        }
    }
    
    
    applySettings() {
        try {
            // Apply font size
            this.setFontSize(this.settings.fontSize, false);
            
            // Apply theme
            this.setTheme(this.settings.theme, false);
            
            // Apply checkbox preferences
            const checkboxes = {
                soundNotifications: 'soundNotifications',
                joinLeaveNotifications: 'joinLeaveNotifications', 
                typingIndicator: 'typingIndicator',
                enterToSend: 'enterToSend',
                timestampDisplay: 'timestampDisplay',
                compactMode: 'compactMode',
                autoScroll: 'autoScroll',
                saveHistory: 'saveHistory',
                shareAnalytics: 'shareAnalytics'
            };
            
            Object.entries(checkboxes).forEach(([setting, id]) => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = this.settings[setting];
                }
            });
            
            // Apply compact mode class
            if (this.settings.compactMode) {
                document.body.classList.add('compact-mode');
            }
            
            console.log('✅ Settings applied successfully');
        } catch (error) {
            console.error('❌ Error applying settings:', error);
        }
    }
    
    
    openSettings() {
        try {
            if (this.settingsModal) {
                this.settingsModal.style.display = 'flex';
                // Load current settings into the UI
                this.applySettings();
            }
        } catch (error) {
            console.error('❌ Error opening settings:', error);
        }
    }
    
    
    closeSettings() {
        try {
            if (this.settingsModal) {
                this.settingsModal.style.display = 'none';
            }
        } catch (error) {
            console.error('❌ Error closing settings:', error);
        }
    }
    
    
    saveSettings() {
        try {
            // Collect current settings from UI
            const fontSize = document.querySelector('.font-size-btn.active')?.dataset.size || 'medium';
            const theme = this.themeToggle?.classList.contains('active') ? 'light' : 'dark';
            
            this.settings = {
                fontSize: fontSize,
                theme: theme,
                soundNotifications: document.getElementById('soundNotifications')?.checked || false,
                joinLeaveNotifications: document.getElementById('joinLeaveNotifications')?.checked || false,
                typingIndicator: document.getElementById('typingIndicator')?.checked || false,
                enterToSend: document.getElementById('enterToSend')?.checked || false,
                timestampDisplay: document.getElementById('timestampDisplay')?.checked || false,
                compactMode: document.getElementById('compactMode')?.checked || false,
                autoScroll: document.getElementById('autoScroll')?.checked || false,
                saveHistory: document.getElementById('saveHistory')?.checked || false,
                shareAnalytics: document.getElementById('shareAnalytics')?.checked || false
            };
            
            // Save to localStorage
            localStorage.setItem('waymaker_settings', JSON.stringify(this.settings));
            
            // Apply the settings
            this.applySettings();
            
            // Close modal
            this.closeSettings();
            
            // Show success notification
            this.showNotification('✅ Settings saved successfully!', 'green');
            
            console.log('✅ Settings saved:', this.settings);
        } catch (error) {
            console.error('❌ Error saving settings:', error);
            this.showNotification('❌ Error saving settings', 'red');
        }
    }
    
    
    resetSettings() {
        if (confirm('Reset all settings to defaults?\n\nThis will restore the original WayMaker AI chat experience.')) {
            try {
                localStorage.removeItem('waymaker_settings');
                this.resetToDefaults();
                this.showNotification('↩️ Settings reset to defaults', 'blue');
            } catch (error) {
                console.error('❌ Error resetting settings:', error);
            }
        }
    }
    
    
    resetToDefaults() {
        this.settings = {
            fontSize: 'medium',
            theme: 'dark', 
            soundNotifications: true,
            joinLeaveNotifications: true,
            typingIndicator: true,
            enterToSend: true,
            timestampDisplay: true,
            compactMode: false,
            autoScroll: true,
            saveHistory: true,
            shareAnalytics: false
        };
        this.applySettings();
    }
    
    
    setFontSize(size, save = true) {
        try {
            // Remove active class from all buttons
            this.fontSizeButtons?.forEach(btn => btn.classList.remove('active'));
            
            // Add active class to selected button
            const selectedBtn = document.querySelector(`[data-size="${size}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }
            
            // Remove existing font size classes
            document.body.classList.remove('font-small', 'font-medium', 'font-large', 'font-xlarge');
            
            // Add new font size class
            document.body.classList.add(`font-${size}`);
            
            if (save) {
                this.settings.fontSize = size;
                localStorage.setItem('waymaker_settings', JSON.stringify(this.settings));
                this.showNotification(`📝 Font size: ${size}`, 'blue');
            }
        } catch (error) {
            console.error('❌ Error setting font size:', error);
        }
    }
    
    
    toggleTheme() {
        const currentTheme = this.settings?.theme || 'dark';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        this.setTheme(newTheme, true);
    }
    
    
    setTheme(theme, save = true) {
        try {
            // Update toggle UI
            if (this.themeToggle) {
                if (theme === 'light') {
                    this.themeToggle.classList.add('active');
                } else {
                    this.themeToggle.classList.remove('active');
                }
            }
            
            // Apply theme classes
            if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
            
            if (save) {
                this.settings.theme = theme;
                localStorage.setItem('waymaker_settings', JSON.stringify(this.settings));
                this.showNotification(`🌙 Theme: ${theme}`, 'blue');
            }
        } catch (error) {
            console.error('❌ Error setting theme:', error);
        }
    }
}

// Initialize enhanced group chat when page loads
let chat;
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM loaded, starting enhanced group chat...');
    
    try {
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.get('name')) {
            console.log('No user session found, redirecting to auth...');
            window.location.href = 'auth.html';
            return;
        }
        
        window.chat = new WayMakerGroupChat();
        
        // Load settings after chat initialization
        setTimeout(() => {
            if (window.chat) {
                window.chat.loadSettings();
            }
        }, 1000);
        
        // Initialize admin extension
        setTimeout(() => {
            if (typeof initializeWayMakerAdmin === 'function') {
                initializeWayMakerAdmin();
            }
        }, 500);
        
        // Initialize admin extension
        if (typeof initializeAdminExtension === 'function') {
            initializeAdminExtension(chat);
        }
        
        const style = document.createElement('style');
        style.textContent = '.message:hover .message-actions { opacity: 1 !important; }';
        document.head.appendChild(style);
        
        console.log('✅ WayMaker AI Enhanced Community Chat initialized successfully');
    } catch (error) {
        console.error('❌ Failed to initialize chat:', error);
        
        // Show error message to user
        const userInfoDisplay = document.getElementById('userInfoDisplay');
        if (userInfoDisplay) {
            userInfoDisplay.innerHTML = '<span class="text-red-400">⚠️ Failed to initialize chat. Please refresh the page.</span>';
        }
    }
});

console.log('✅ WayMaker AI Enhanced Community Chat script loaded successfully');
</script>

</body>
</html>