<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WayMaker AI - Enhanced Community Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- WayMaker Admin Extension -->
    <script src="waymaker-admin.js"></script>
    <style>
        /* Prevent entire page from scrolling */
        html, body {
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        
        /* Enhanced message styling with edit/delete functionality */
        .message:hover .message-actions {
            opacity: 1 !important;
        }
        
        .message-actions {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .typing-cursor {
            color: #3b82f6;
            font-weight: bold;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .message-content {
            transition: transform 0.2s ease;
        }
        
        .user-badge {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            font-size: 0.65rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.375rem;
            font-weight: bold;
        }
        
        /* Enhanced sidebar - full height coverage */
        .sidebar-section {
            background: #1f2937;
            border: 1px solid #374151;
            margin: 0.5rem;
            border-radius: 0.5rem;
        }
        
        .sidebar-full-height {
            height: calc(100vh - 20px); /* Slightly less than full height */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent sidebar itself from scrolling */
            padding: 10px 0; /* Add some top/bottom padding */
        }
        
        .sidebar-section.fill-remaining {
            flex: 0 0 auto !important; /* Don't grow to fill space */
            max-height: 200px !important; /* Smaller to fit better */
            min-height: 100px !important; /* Minimum usable height */
            display: flex !important;
            flex-direction: column !important;
        }
        
        .history-content {
            flex: 1 !important;
            overflow-y: auto !important;
            min-height: 0 !important;
            max-height: 150px !important; /* Reduced to fit in viewport */
        }
        
        .compact-button {
            background: #374151;
            color: #d1d5db;
            transition: all 0.2s ease;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
        }
        
        .compact-button:hover {
            background: #4b5563;
            color: #f9fafb;
        }
        
        .compact-button.prayer { background: #7c3aed; color: white; }
        .compact-button.prayer:hover { background: #6d28d9; }
        .compact-button.verse { background: #059669; color: white; }
        .compact-button.verse:hover { background: #047857; }
        .compact-button.export { background: #2563eb; color: white; }
        .compact-button.export:hover { background: #1d4ed8; }
        .compact-button.exit { background: #dc2626; color: white; }
        .compact-button.exit:hover { background: #b91c1c; }
        .compact-button.new-session { background: #d97706; color: white; }
        .compact-button.new-session:hover { background: #b45309; }
        
        .history-item {
            background: #374151;
            color: #d1d5db;
            transition: all 0.2s ease;
            font-size: 0.7rem;
            padding: 0.25rem;
            cursor: pointer;
            border-radius: 0.375rem;
            margin-bottom: 0.25rem;
        }
        
        .history-item:hover {
            background: #4b5563;
        }
        
        /* MINIMAL SCROLLBAR STYLING */
        ::-webkit-scrollbar {
            width: 2px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 1px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Specific minimal scrollbars for different sections */
        #historyList::-webkit-scrollbar,
        #messagesContainer::-webkit-scrollbar {
            width: 2px;
        }
        
        #historyList::-webkit-scrollbar-track,
        #messagesContainer::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #historyList::-webkit-scrollbar-thumb,
        #messagesContainer::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 1px;
        }
        
        #historyList::-webkit-scrollbar-thumb:hover,
        #messagesContainer::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Firefox minimal scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: #4b5563 transparent;
        }
        
        .chat-input {
            background: #374151;
            border: 2px solid #4b5563;
            color: #f9fafb;
            font-size: 0.875rem;
        }
        
        .chat-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .compact-message {
            font-size: 0.8rem;
            line-height: 1.3;
        }

        .compact-user-list {
            font-size: 0.7rem;
        }

        .top-action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Enhanced message action buttons */
        .action-button {
            background: #4b5563;
            color: #d1d5db;
            border: none;
            border-radius: 0.25rem;
            padding: 0.125rem 0.375rem;
            font-size: 0.625rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-button:hover {
            background: #6b7280;
            color: #f9fafb;
        }

        .action-button.edit {
            background: #059669;
            color: white;
        }

        .action-button.edit:hover {
            background: #047857;
        }

        .action-button.delete {
            background: #dc2626;
            color: white;
        }

        .action-button.delete:hover {
            background: #b91c1c;
        }

        /* Admin-specific styles */
        .admin-badge {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            font-size: 0.6rem;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .admin-edit {
            background: #f59e0b !important;
            color: white !important;
        }

        .admin-edit:hover {
            background: #d97706 !important;
        }

        .admin-delete {
            background: #ef4444 !important;
            color: white !important;
        }

        .admin-delete:hover {
            background: #dc2626 !important;
        }

        #adminPanel {
            border-left: 3px solid #dc2626;
        }

        #adminPanel button {
            font-size: 0.6rem;
            padding: 0.25rem 0.5rem;
        }

        /* Edit mode styling */
        .edit-mode .message-content {
            background: #374151 !important;
            border: 2px solid #3b82f6;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }

        .edit-controls {
            margin-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        /* API Status indicator */
        .api-status {
            font-size: 0.65rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.375rem;
            font-weight: bold;
        }

        .api-status.connected {
            background: #10b981;
            color: white;
        }

        .api-status.disconnected {
            background: #ef4444;
            color: white;
        }

        .api-status.fallback {
            background: #f59e0b;
            color: white;
        }

        /* Loading animation */
        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #374151;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error state styling */
        .error-state {
            background: #dc2626;
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin: 0.5rem;
        }

        .success-state {
            background: #059669;
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin: 0.5rem;
        }

        /* Optimized layout for better content visibility */
        .chat-container {
            height: 100vh;
            overflow: hidden; /* Prevent container from scrolling */
        }
        
        /* Ensure chat area uses remaining height and only messages scroll */
        .chat-area {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-bottom: 80px; /* Space for input area */
        }
        
        #messagesContainer {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            margin-bottom: 10px; /* Space above input */
        }
        
        /* Input area positioning */
        .input-area {
            position: fixed;
            bottom: 0;
            right: 0;
            left: 256px; /* Width of sidebar (w-64 = 256px) */
            background: #1f2937;
            border-top: 1px solid #374151;
            z-index: 10;
        }

        .welcome-banner {
            min-height: auto;
            padding: 0.5rem;
        }

        .messages-area {
            height: calc(100% - 120px);
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    
    <!-- Enhanced Header with User Info and Actions -->
    <div class="bg-gray-800 border-b border-gray-700 p-2">
         <div class="flex justify-between items-start">
            <div class="flex-1">
                <h1 class="text-white text-lg font-bold flex items-center gap-2 mb-1">
                    âœï¸âšª WayMaker AI - Enhanced Community Chat
                    <span class="text-xs text-gray-300 font-normal">Your path to living God's will â€” step by step</span>
                </h1>
                
                <!-- Action Buttons in Header -->
                <div class="top-action-buttons">
                    <button id="prayerBtn" class="compact-button prayer" title="Prayer request">ğŸ™ Prayer</button>
                    <button id="verseBtn" class="compact-button verse" title="Bible verse lookup">ğŸ“– Verse</button>
                    <button id="exportBtn" class="compact-button export" title="Export chat">ğŸ’¾ Export</button>
                    <button id="newSessionBtn" class="compact-button new-session" title="New session">ğŸ”„ New</button>
                    <button id="exitChatBtn" class="compact-button exit" title="Exit chat">ğŸšª Exit</button>
                </div>
            </div>
            
            <div class="text-right">
                <div class="text-white font-semibold text-sm" id="userDisplay">Welcome, Friend!</div>
                <div class="flex gap-1 mt-1">
                    <span class="user-badge" id="userTypeBadge">Individual</span>
                    <span class="user-badge" id="accessTierBadge">Basic</span>
                    <span class="api-status connected" id="apiStatus">âœ“ Connected</span>
                    <button id="headerExitBtn" class="user-badge bg-red-500 hover:bg-red-600 cursor-pointer" title="Exit">ğŸšª</button>
                </div>
                <div class="text-gray-400 text-xs mt-1">
                    <span id="sessionInfo">Session-based (No data stored)</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="flex chat-container">
        
        <!-- Enhanced Full-Height Sidebar -->
        <div class="w-64 bg-gray-800 border-r border-gray-700 sidebar-full-height">
            
            <!-- Community Members -->
            <div class="sidebar-section">
                <div class="p-2 border-b border-gray-600">
                    <h3 class="font-semibold text-white mb-1 text-sm">Community Members</h3>
                    <ul id="userList" class="space-y-0.5 compact-user-list"></ul>
                </div>
            </div>
            
            <!-- Enhanced Features -->
            <div class="sidebar-section">
                <div class="p-2 border-b border-gray-600">
                    <h4 class="font-semibold text-white mb-1 text-sm">Enhanced Features</h4>
                    <div class="grid grid-cols-2 gap-1 text-xs">
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            âœï¸ Edit
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            âŒ Delete
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ğŸ‘ğŸ‘ Rate
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            â“ Suggest
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ğŸ”Š TTS
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ğŸ¤ Voice
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ğŸ“ Upload
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ğŸ“– Study
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ğŸ’¾ Export
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ğŸšª Exit
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- WayMaker AI Triggers -->
            <div class="sidebar-section">
                <div class="p-2 border-b border-gray-600">
                    <h4 class="font-semibold text-white mb-1 text-sm">WayMaker AI responds to:</h4>
                    <div class="grid grid-cols-2 gap-1 text-xs">
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ğŸ”· WayMaker
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ğŸ“– Biblical
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ğŸ™ Prayer
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ğŸŒŸ Spiritual
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ğŸ’­ Faith
                        </div>
                        <div class="px-2 py-1 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-xs transition-colors cursor-default">
                            ğŸ‘¥ Community
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live API Status -->
            <div class="sidebar-section">
                <div class="p-2 border-b border-gray-600">
                    <h4 class="font-semibold text-white mb-1 text-sm">ğŸ”— Connection Status</h4>
                    <ul class="text-xs text-gray-300 space-y-0.5">
                        <li id="apiStatusText">ğŸ”„ Testing connection...</li>
                        <li id="supabaseStatusText">ğŸ”„ Initializing real-time...</li>
                        <li id="lastApiCall">Last response: Initializing...</li>
                    </ul>
                </div>
            </div>
            
            <!-- Enhanced History Section - Fill Remaining Space -->
            <div class="sidebar-section fill-remaining">
                <div class="p-2 border-b border-gray-600">
                    <h4 class="font-semibold text-white mb-2 flex items-center gap-1 text-sm">ğŸ“œ History</h4>
                </div>
                <div class="history-content p-2">
                    <div class="space-y-1" id="historyList">
                        <!-- Dynamic history items -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="flex-1 chat-area bg-gray-900">
            <!-- Enhanced Welcome Banner -->
            <div class="bg-blue-900/20 border-l-4 border-blue-400 welcome-banner m-2 rounded-r-lg">
                <p class="text-xs text-blue-300">
                    <strong>ğŸŒŸ WayMaker AI Enhanced Community Chat!</strong> 
                    <span id="welcomeMessage">Real-time biblical guidance with full editing capabilities and live Dify API connection!</span>
                </p>
            </div>
            
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-3 space-y-2 messages-area"></div>
            
            <!-- Compact Input Area -->
            <div class="border-t border-gray-700 bg-gray-800 p-2 input-area">
                <div class="flex gap-1 mb-2">
                    <div class="px-2 py-1 bg-gray-700 border border-gray-600 rounded text-xs text-gray-300" id="userInfoDisplay">
                        <span class="loading-spinner"></span> Initializing...
                    </div>
                    <input type="file" id="fileInput" multiple class="hidden">
                    <button id="fileBtn" class="px-2 py-1 bg-orange-600 hover:bg-orange-700 text-white rounded text-xs border-none cursor-pointer" title="Upload files">ğŸ“</button>
                    <button id="voiceBtn" class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs border-none cursor-pointer" title="Voice input">ğŸ¤</button>
                    <button id="clearBtn" class="px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs border-none cursor-pointer" title="Clear chat">ğŸ—‘ï¸</button>
                </div>
                
                <div class="flex gap-2">
                    <input type="text" id="messageInput" 
                           placeholder="Share with community, ask questions, or request prayer..."
                           class="chat-input flex-1 px-3 py-2 rounded-full outline-none">
                    <button id="sendButton" 
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full font-medium text-sm border-none cursor-pointer">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
console.log('ğŸš€ WayMaker AI Enhanced Community Chat starting...');

class WayMakerGroupChat {
    constructor() {
        console.log('ğŸ¯ Initializing WayMaker GroupChat...');
        
        // âœ… FIXED: Updated to correct Cloudflare Worker endpoint (no /chat-messages)
        this.apiUrl = 'https://waymaker-proxy.waymaker-ai.workers.dev/';
        this.apiKey = 'app-baSinqrorYUcF4rJZk8qfbpv'; // NEW API key
        this.conversationId = null;
        this.currentMessageId = null;
        this.messageCounter = 0;
        
        // Supabase Real-time system
        this.supabaseUrl = 'https://eoreanpxurhjsvihjzxv.supabase.co';
        this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvcmVhbnB4dXJoanN2aWhqenh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NTMwNjQsImV4cCI6MjA2NTQyOTA2NH0.IVClvbT2NhUyx_XH02bmJNA0fIo4Taf13Y-7oCY-SZI';
        this.supabase = null;
        this.presenceChannel = null;
        this.messagesChannel = null;
        this.activeUsers = [];
        
        // History system
        this.historyCategories = {
            prayer: [], bible_study: [], spiritual_guidance: [],
            community_fellowship: [], crisis_support: [], youth_family: []
        };
        
        // Edit functionality
        this.editingMessageId = null;
        this.originalMessageContent = '';
        
        // API status tracking
        this.lastApiSuccess = null;
        this.apiFailureCount = 0;
        
        // Initialization state
        this.isInitialized = false;
        this.initializationError = null;
        
        this.userInfo = this.extractUserInfoFromURL();
        console.log('ğŸ‘¤ User info extracted:', this.userInfo);
        
        // Start initialization with better error handling
        this.init().catch(error => {
            console.error('âŒ Initialization failed:', error);
            this.initializationError = error;
            this.showInitializationError(error);
        });
    }
    
    extractUserInfoFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const userInfo = {
            name: urlParams.get('name') || 'Friend',
            age: urlParams.get('age') || '18-25',
            language: urlParams.get('language') || 'English',
            type: urlParams.get('type') || 'individual',
            access: urlParams.get('access') || 'basic',
            familySize: urlParams.get('family_size') || null,
            referralCode: urlParams.get('referral') || null
        };
        
        console.log('ğŸ“‹ Extracted user info:', userInfo);
        return userInfo;
    }
    
    async init() {
        try {
            console.log('âœ… Starting initialization sequence...');
            
            // Step 1: Update status immediately
            this.updateInitializationStatus('ğŸ”§ Updating interface...');
            
            // Step 2: Update UI immediately
            this.updateUserInterface();
            console.log('âœ… UI updated');
            
            // Step 3: Bind elements and events (critical for basic functionality)
            this.updateInitializationStatus('ğŸ“ Binding controls...');
            this.bindElements();
            this.attachEvents();
            console.log('âœ… Events attached');
            
            // Step 4: Load history (synchronous, quick)
            this.updateInitializationStatus('ğŸ“œ Loading history...');
            this.loadHistoryCategories();
            this.updateHistoryDisplay();
            console.log('âœ… History loaded');
            
            // Step 5: Add welcome message (immediate feedback)
            this.updateInitializationStatus('ğŸ‘‹ Adding welcome message...');
            this.addWelcomeMessage();
            console.log('âœ… Welcome message added');
            
            // Step 6: Update session info immediately
            this.updateSessionInfo();
            console.log('âœ… Session info updated');
            
            // Step 7: Initialize async components (non-blocking)
            this.updateInitializationStatus('ğŸŒ Connecting to services...');
            await this.initializeAsyncComponents();
            
            // Mark as initialized
            this.isInitialized = true;
            this.updateInitializationStatus('âœ… Ready!');
            console.log('ğŸ‰ Enhanced group chat initialized successfully!');
            
            // Final status update
            setTimeout(() => {
                this.updateInitializationStatus(`${this.userInfo.name} (${this.userInfo.age}, ${this.capitalizeFirst(this.userInfo.type.replace('_', ' '))})`);
            }, 2000);
            
        } catch (error) {
            console.error('âŒ Initialization error:', error);
            this.initializationError = error;
            this.showInitializationError(error);
            throw error;
        }
    }
    
    updateInitializationStatus(message) {
        try {
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            if (userInfoDisplay) {
                if (message.startsWith('âœ…')) {
                    userInfoDisplay.innerHTML = `<span class="text-green-400">${message}</span>`;
                } else if (message.startsWith('âŒ') || message.startsWith('âš ï¸')) {
                    userInfoDisplay.innerHTML = `<span class="text-red-400">${message}</span>`;
                } else if (message.startsWith('ğŸ”„') || message.startsWith('ğŸ”§') || message.startsWith('ğŸ“') || message.startsWith('ğŸ“œ') || message.startsWith('ğŸ‘‹') || message.startsWith('ğŸŒ')) {
                    userInfoDisplay.innerHTML = `<span class="loading-spinner"></span> ${message}`;
                } else {
                    userInfoDisplay.textContent = message;
                }
            }
        } catch (error) {
            console.error('âŒ Error updating initialization status:', error);
        }
    }
    
    async initializeAsyncComponents() {
        console.log('ğŸ”„ Initializing async components...');
        
        try {
            // Initialize Supabase with timeout
            const supabasePromise = Promise.race([
                this.initializeSupabase(),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Supabase timeout')), 10000))
            ]);
            
            await supabasePromise.catch(error => {
                console.warn('âš ï¸ Supabase initialization failed:', error);
                this.updateConnectionStatus('supabase', false, 'Real-time chat unavailable');
                this.startLocalMode();
            });
            
            // Test API connection with timeout
            const apiPromise = Promise.race([
                this.testApiConnection(),
                new Promise((_, reject) => setTimeout(() => reject(new Error('API timeout')), 8000))
            ]);
            
            await apiPromise.catch(error => {
                console.warn('âš ï¸ API test failed:', error);
                this.updateApiStatus('fallback', 'API unavailable - using fallback');
            });
            
            console.log('âœ… Async components initialized');
        } catch (error) {
            console.error('âŒ Async component initialization failed:', error);
            // Continue with local mode
            this.startLocalMode();
        }
    }
    
    updateConnectionStatus(service, connected, message) {
        try {
            if (service === 'supabase') {
                const el = document.getElementById('supabaseStatusText');
                if (el) {
                    el.textContent = connected ? 'âœ“ Real-time chat active' : `âš ï¸ ${message}`;
                    el.className = connected ? 'text-green-400' : 'text-yellow-400';
                }
            } else if (service === 'api') {
                const el = document.getElementById('apiStatusText');
                if (el) {
                    el.textContent = connected ? 'âœ“ Connected to Dify API' : `âš ï¸ ${message}`;
                    el.className = connected ? 'text-green-400' : 'text-yellow-400';
                }
            }
        } catch (error) {
            console.error('âŒ Error updating connection status:', error);
        }
    }
    
    showInitializationError(error) {
        console.error('âŒ Showing initialization error:', error);
        
        this.updateInitializationStatus(`âš ï¸ Error: ${error.message}`);
        
        // Show error notification
        this.showNotification(`Initialization error: ${error.message}. Using offline mode.`, 'red');
        
        // Still try to provide basic functionality
        setTimeout(() => {
            this.startLocalMode();
            this.updateInitializationStatus(`${this.userInfo.name} (Offline Mode)`);
        }, 3000);
    }
    
    updateSessionInfo() {
        try {
            console.log('ğŸ“± Updating session info...');
            
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            if (userInfoDisplay && this.userInfo) {
                const sessionText = `${this.userInfo.name} (${this.userInfo.age}, ${this.capitalizeFirst(this.userInfo.type.replace('_', ' '))}`;
                userInfoDisplay.textContent = sessionText;
            }
            
            console.log('âœ… Session info updated successfully');
        } catch (error) {
            console.error('âŒ Error updating session info:', error);
        }
    }
    
    updateUserInterface() {
        try {
            console.log('ğŸ¨ Updating user interface...');
            
            const userDisplay = document.getElementById('userDisplay');
            if (userDisplay) {
                userDisplay.textContent = `Welcome, ${this.userInfo.name}!`;
            }
            
            const userTypeBadge = document.getElementById('userTypeBadge');
            if (userTypeBadge) {
                userTypeBadge.textContent = this.capitalizeFirst(this.userInfo.type.replace('_', ' '));
            }
            
            const accessTierBadge = document.getElementById('accessTierBadge');
            if (accessTierBadge) {
                accessTierBadge.textContent = this.capitalizeFirst(this.userInfo.access);
            }
            
            const sessionInfo = `${this.userInfo.age} â€¢ ${this.userInfo.language}`;
            const sessionInfoEl = document.getElementById('sessionInfo');
            if (sessionInfoEl) {
                sessionInfoEl.textContent = sessionInfo;
            }
            
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage) {
                welcomeMessage.textContent = `Real-time biblical guidance with edit/delete features and live Dify API connection!`;
            }
            
            console.log('âœ… User interface updated successfully');
        } catch (error) {
            console.error('âŒ Error updating user interface:', error);
        }
    }
    
    capitalizeFirst(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }
    
    bindElements() {
        try {
            console.log('ğŸ”— Binding DOM elements...');
            
            this.messagesContainer = document.getElementById('messagesContainer');
            this.messageInput = document.getElementById('messageInput');
            this.sendButton = document.getElementById('sendButton');
            this.userList = document.getElementById('userList');
            this.historyList = document.getElementById('historyList');
            this.fileInput = document.getElementById('fileInput');
            this.fileBtn = document.getElementById('fileBtn');
            this.voiceBtn = document.getElementById('voiceBtn');
            this.clearBtn = document.getElementById('clearBtn');
            this.prayerBtn = document.getElementById('prayerBtn');
            this.verseBtn = document.getElementById('verseBtn');
            this.exportBtn = document.getElementById('exportBtn');
            this.newSessionBtn = document.getElementById('newSessionBtn');
            this.exitChatBtn = document.getElementById('exitChatBtn');
            this.headerExitBtn = document.getElementById('headerExitBtn');
            this.apiStatus = document.getElementById('apiStatus');
            this.apiStatusText = document.getElementById('apiStatusText');
            this.supabaseStatusText = document.getElementById('supabaseStatusText');
            this.lastApiCall = document.getElementById('lastApiCall');
            
            // Validate critical elements
            if (!this.messagesContainer) {
                throw new Error('Messages container not found');
            }
            if (!this.messageInput) {
                throw new Error('Message input not found');
            }
            if (!this.sendButton) {
                throw new Error('Send button not found');
            }
            
            console.log('âœ… DOM elements bound successfully');
        } catch (error) {
            console.error('âŒ Error binding elements:', error);
            throw error;
        }
    }
    
    attachEvents() {
        try {
            console.log('ğŸ“ Attaching event listeners...');
            
            if (this.sendButton) {
                this.sendButton.onclick = () => this.sendMessage();
            }
            
            if (this.messageInput) {
                this.messageInput.onkeypress = (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                };
            }
            
            if (this.fileBtn && this.fileInput) {
                this.fileBtn.onclick = () => this.fileInput.click();
            }
            
            if (this.voiceBtn) {
                this.voiceBtn.onclick = () => this.startVoiceInput();
            }
            
            if (this.clearBtn) {
                this.clearBtn.onclick = () => this.clearChat();
            }
            
            if (this.prayerBtn) {
                this.prayerBtn.onclick = () => this.handlePrayerRequest();
            }
            
            if (this.verseBtn) {
                this.verseBtn.onclick = () => this.handleVerseLookup();
            }
            
            if (this.exportBtn) {
                this.exportBtn.onclick = () => this.exportConversation();
            }
            
            if (this.newSessionBtn) {
                this.newSessionBtn.onclick = () => this.startNewSession();
            }
            
            if (this.exitChatBtn) {
                this.exitChatBtn.onclick = () => this.exitChat();
            }
            
            if (this.headerExitBtn) {
                this.headerExitBtn.onclick = () => this.exitChat();
            }
            
            if (this.fileInput) {
                this.fileInput.onchange = (e) => this.handleFileUpload(e);
            }
            
            console.log('âœ… Event listeners attached successfully');
        } catch (error) {
            console.error('âŒ Error attaching events:', error);
            throw error;
        }
    }

    // Enhanced API Status Management
    async testApiConnection() {
        try {
            console.log('ğŸ”„ Testing API connection...');
            
            const testPayload = {
                inputs: {
                    user_name: this.userInfo.name,
                    topic: "test connection",
                    spiritual_context: "general"
                },
                query: "Test connection",
                response_mode: 'blocking',
                user: this.userInfo.name
            };

            const response = await fetch(this.apiUrl, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + this.apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(testPayload)
            });

            if (response.ok) {
                this.updateApiStatus('connected', 'Connected to Dify API');
                this.updateConnectionStatus('api', true, 'Connected');
                console.log('âœ… API connection test successful');
                return true;
            } else {
                throw new Error(`API test failed: ${response.status}`);
            }
        } catch (error) {
            console.warn('âš ï¸ API connection test failed:', error);
            this.updateApiStatus('fallback', 'Using fallback responses');
            this.updateConnectionStatus('api', false, 'Using fallback responses');
            return false;
        }
    }

    updateApiStatus(status, message) {
        try {
            const statusEl = this.apiStatus;
            const textEl = this.apiStatusText;
            const lastCallEl = this.lastApiCall;
            
            if (statusEl) {
                statusEl.className = `api-status ${status}`;
                
                switch(status) {
                    case 'connected':
                        statusEl.textContent = 'âœ“ Live API';
                        this.lastApiSuccess = new Date();
                        this.apiFailureCount = 0;
                        break;
                    case 'fallback':
                        statusEl.textContent = 'âš  Fallback';
                        this.apiFailureCount++;
                        break;
                    case 'disconnected':
                        statusEl.textContent = 'âœ— Offline';
                        this.apiFailureCount++;
                        break;
                }
            }
            
            if (textEl) {
                textEl.textContent = message;
            }
            
            if (lastCallEl) {
                const timeText = this.lastApiSuccess ? 
                    this.getTimeAgo(this.lastApiSuccess) : 'Initializing...';
                lastCallEl.textContent = `Last response: ${timeText}`;
            }
        } catch (error) {
            console.error('âŒ Error updating API status:', error);
        }
    }
    
    // âœ¨ SUPABASE REALTIME GROUP CHAT SYSTEM âœ¨
    
    async initializeSupabase() {
        try {
            console.log('ğŸš€ Initializing Supabase Group Chat...');
            
            if (typeof supabase === 'undefined') {
                throw new Error('Supabase library not loaded');
            }
            
            this.supabase = supabase.createClient(this.supabaseUrl, this.supabaseKey);
            console.log('âœ… Supabase client created');
            
            await this.startSupabasePresence();
            await this.startSupabaseMessaging();
            
            this.updateConnectionStatus('supabase', true, 'Real-time chat active');
            
        } catch (error) {
            console.error('âŒ Supabase initialization failed:', error);
            this.updateConnectionStatus('supabase', false, 'Real-time chat unavailable');
            this.startLocalMode();
        }
    }
    
    async startSupabasePresence() {
        try {
            this.presenceChannel = this.supabase.channel('waymaker-presence', {
                config: { presence: { key: this.userInfo.name } }
            });
            
            const presenceState = {
                user_id: this.userInfo.name,
                username: this.userInfo.name,
                user_type: this.userInfo.type,
                user_age: this.userInfo.age,
                online_at: new Date().toISOString()
            };
            
            this.presenceChannel.on('presence', { event: 'sync' }, () => {
                const presenceState = this.presenceChannel.presenceState();
                this.updateUserListFromSupabase(presenceState);
            });
            
            this.presenceChannel.on('presence', { event: 'join' }, ({ key, newPresences }) => {
                newPresences.forEach(presence => {
                    if (presence.username !== this.userInfo.name) {
                        this.showUserJoinedNotification(presence.username);
                    }
                });
            });
            
            this.presenceChannel.on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                leftPresences.forEach(presence => {
                    if (presence.username !== this.userInfo.name) {
                        this.showUserLeftNotification(presence.username);
                    }
                });
            });
            
            await this.presenceChannel.subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    await this.presenceChannel.track(presenceState);
                    console.log('âœ… Presence tracked:', presenceState);
                    this.showJoinNotification();
                }
            });
            
        } catch (error) {
            console.error('âŒ Presence setup failed:', error);
        }
    }
    
    async startSupabaseMessaging() {
        try {
            console.log('ğŸ’¬ Starting group messaging channel...');
            
            this.messagesChannel = this.supabase.channel('waymaker-messages');
            
            this.messagesChannel.on('broadcast', { event: 'new_message' }, (payload) => {
                console.log('ğŸ“¨ Received group message:', payload);
                
                if (payload.payload.sender !== this.userInfo.name) {
                    this.addMessageToUI(
                        payload.payload.content,
                        payload.payload.type,
                        payload.payload.sender,
                        payload.payload.shouldStream
                    );
                }
            });
            
            await this.messagesChannel.subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    console.log('âœ… Group messaging channel subscribed');
                }
            });
            
        } catch (error) {
            console.error('âŒ Group messaging setup failed:', error);
        }
    }
    
    async broadcastMessage(content, type, sender, shouldStream = false) {
        if (this.messagesChannel) {
            try {
                await this.messagesChannel.send({
                    type: 'broadcast',
                    event: 'new_message',
                    payload: {
                        content: content,
                        type: type,
                        sender: sender,
                        shouldStream: shouldStream,
                        timestamp: new Date().toISOString()
                    }
                });
                console.log('ğŸ“¤ Message broadcasted to group');
            } catch (error) {
                console.error('âŒ Failed to broadcast message:', error);
            }
        }
    }
    
    updateUserListFromSupabase(presenceState) {
        const users = [];
        
        users.push({ name: 'WayMaker AI', isBot: true, joinedAt: 0 });
        
        Object.values(presenceState).forEach(presences => {
            presences.forEach(presence => {
                if (!presence.username || presence.username === 'WayMaker AI') return;
                
                users.push({
                    name: presence.username,
                    type: presence.user_type,
                    age: presence.user_age,
                    isBot: false,
                    joinedAt: presence.online_at ? new Date(presence.online_at).getTime() / 1000 : Date.now() / 1000
                });
            });
        });
        
        this.activeUsers = users;
        this.renderUserList(users);
    }
    
    renderUserList(users) {
        if (!this.userList) return;
        
        this.userList.innerHTML = '';
        
        users.forEach(user => {
            const li = document.createElement('li');
            li.className = 'flex items-center gap-1 text-gray-300 text-xs py-0.5';
            
            if (user.isBot) {
                li.innerHTML = `
                    <div class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse"></div>
                    <span class="text-blue-300 font-medium">ğŸ¤– ${user.name}</span>
                    <span class="text-xs text-gray-500 ml-auto">AI</span>
                `;
            } else {
                const isCurrentUser = user.name === this.userInfo.name;
                const timeOnline = this.getTimeOnline(user.joinedAt);
                
                li.innerHTML = `
                    <div class="w-1.5 h-1.5 bg-green-400 rounded-full"></div>
                    <span class="${isCurrentUser ? 'text-yellow-300 font-medium' : 'text-gray-300'}">${user.name}${isCurrentUser ? ' (you)' : ''}</span>
                    <span class="text-xs text-gray-500 ml-auto">${timeOnline}</span>
                `;
            }
            
            this.userList.appendChild(li);
        });
        
        this.updateCommunityCount(users.length);
    }
    
    startLocalMode() {
        console.log('ğŸ”„ Using local mode fallback...');
        const users = [
            { name: 'WayMaker AI', isBot: true, joinedAt: 0 },
            { name: this.userInfo.name, isBot: false, joinedAt: Date.now() / 1000 }
        ];
        this.activeUsers = users;
        this.renderUserList(users);
        this.showJoinNotification();
    }
    
    getTimeOnline(joinedAt) {
        if (!joinedAt || joinedAt === 0) return 'Always';
        const now = Date.now() / 1000;
        const onlineSeconds = Math.floor(now - joinedAt);
        if (onlineSeconds < 60) return 'Just joined';
        if (onlineSeconds < 3600) return `${Math.floor(onlineSeconds / 60)}m`;
        if (onlineSeconds < 86400) return `${Math.floor(onlineSeconds / 3600)}h`;
        return `${Math.floor(onlineSeconds / 86400)}d`;
    }
    
    updateCommunityCount(count) {
        try {
            const header = document.querySelector('#userList')?.parentElement?.querySelector('h3');
            if (header) {
                header.textContent = `Community Members (${count})`;
            }
        } catch (error) {
            console.error('âŒ Error updating community count:', error);
        }
    }
    
    showJoinNotification() {
        this.showNotification('âœ… Connected to WayMaker community!', 'green');
    }
    
    showUserJoinedNotification(userName) {
        if (userName === this.userInfo.name) return;
        this.showNotification(`ğŸ™ ${userName} joined the community`, 'blue');
    }
    
    showUserLeftNotification(userName) {
        if (userName === this.userInfo.name) return;
        this.showNotification(`ğŸ‘‹ ${userName} left the community`, 'gray');
    }
    
    cleanup() {
        try {
            if (this.presenceChannel) {
                this.presenceChannel.untrack();
                this.presenceChannel.unsubscribe();
            }
            if (this.messagesChannel) {
                this.messagesChannel.unsubscribe();
            }
        } catch (error) {
            console.error('âŒ Error during cleanup:', error);
        }
    }
    
    // Enhanced Features
    
    loadHistoryCategories() {
        try {
            const saved = sessionStorage.getItem('waymaker_history_categories');
            if (saved) {
                this.historyCategories = JSON.parse(saved);
            }
        } catch (e) {
            console.log('Could not load history:', e);
        }
    }
    
    saveHistoryCategories() {
        try {
            sessionStorage.setItem('waymaker_history_categories', JSON.stringify(this.historyCategories));
        } catch (e) {
            console.log('Session storage not available:', e);
        }
    }
    
    updateHistoryDisplay() {
        const historyContainer = this.historyList;
        if (!historyContainer) return;
        
        const categories = [
            { key: 'prayer', icon: 'ğŸ™', title: 'Prayer' },
            { key: 'bible_study', icon: 'ğŸ“–', title: 'Bible' },
            { key: 'spiritual_guidance', icon: 'ğŸ’­', title: 'Guidance' },
            { key: 'community_fellowship', icon: 'ğŸ¤', title: 'Fellowship' },
            { key: 'crisis_support', icon: 'ğŸ’ª', title: 'Support' },
            { key: 'youth_family', icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', title: 'Family' }
        ];
        
        historyContainer.innerHTML = '';
        
        categories.forEach(category => {
            const items = this.historyCategories[category.key] || [];
            const latestItem = items[0];
            
            const div = document.createElement('div');
            div.className = 'history-item cursor-pointer';
            
            const count = items.length;
            const timeAgo = latestItem ? this.getTimeAgo(latestItem.timestamp) : 'None';
            const preview = latestItem ? (latestItem.preview.length > 15 ? latestItem.preview.substring(0, 15) + '...' : latestItem.preview) : 'No activity';
            
            div.innerHTML = `
                <div class="flex items-center gap-1 mb-0.5">
                    <span class="text-xs">${category.icon}</span>
                    <span class="text-xs font-medium truncate">${category.title}</span>
                </div>
                <div class="text-xs mb-0.5 text-gray-400">${count} â€¢ ${timeAgo}</div>
                <div class="text-xs truncate text-gray-300">"${preview}"</div>
            `;
            
            div.onclick = () => this.loadCategoryHistory(category.key, category.title);
            historyContainer.appendChild(div);
        });
    }
    
    getTimeAgo(timestamp) {
        if (!timestamp) return 'Unknown';
        try {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return past.toLocaleDateString();
        } catch (e) {
            return 'Recently';
        }
    }
    
    loadCategoryHistory(categoryKey, categoryTitle) {
        const items = this.historyCategories[categoryKey] || [];
        if (items.length === 0) {
            alert(`No ${categoryTitle.toLowerCase()} history yet.`);
            return;
        }
        const historyText = items.map((item, index) => 
            `${index + 1}. [${this.getTimeAgo(item.timestamp)}] ${item.preview}`
        ).join('\n\n');
        const userChoice = confirm(`${categoryTitle} History:\n\n${historyText}\n\nLoad one into input?`);
        if (userChoice && items.length > 0) {
            if (this.messageInput) {
                this.messageInput.value = items[0].preview;
                this.messageInput.focus();
            }
        }
    }
    
    addToHistory(type, preview, icon = 'ğŸ’¬') {
        const historyItem = {
            type: type, preview: preview, icon: icon,
            timestamp: new Date().toISOString()
        };
        
        let category = 'spiritual_guidance';
        if (type === 'Prayer Request' || type.toLowerCase().includes('prayer') || preview.toLowerCase().includes('pray')) {
            category = 'prayer';
        } else if (type === 'Bible Study' || type.toLowerCase().includes('verse') || type.toLowerCase().includes('biblical') || preview.toLowerCase().includes('bible')) {
            category = 'bible_study';
        } else if (preview.toLowerCase().includes('crisis') || preview.toLowerCase().includes('help') || preview.toLowerCase().includes('emergency')) {
            category = 'crisis_support';
        } else if (preview.toLowerCase().includes('family') || preview.toLowerCase().includes('children') || preview.toLowerCase().includes('youth')) {
            category = 'youth_family';
        } else if (preview.toLowerCase().includes('community') || preview.toLowerCase().includes('fellowship') || preview.toLowerCase().includes('church')) {
            category = 'community_fellowship';
        }
        
        this.historyCategories[category].unshift(historyItem);
        if (this.historyCategories[category].length > 10) {
            this.historyCategories[category] = this.historyCategories[category].slice(0, 10);
        }
        
        this.saveHistoryCategories();
        this.updateHistoryDisplay();
    }
    
    addWelcomeMessage() {
        try {
            console.log('ğŸ‘‹ Adding welcome message...');
            
            let welcome = `Peace be with you, ${this.userInfo.name}! ğŸ‘‹\n\nWelcome to WayMaker AI Enhanced Community Chat - now with full editing capabilities and live API connection! `;
            
            if (this.userInfo.type === 'family') {
                welcome += `Families like yours find strength sharing biblical wisdom together.\n\n`;
            } else if (this.userInfo.type === 'community_partner') {
                welcome += `Thank you for your ministry leadership - your voice strengthens our community.\n\n`;
            } else {
                welcome += `Share your spiritual journey with our growing faith community.\n\n`;
            }
            
            if (this.userInfo.access === 'equity') {
                welcome += `ğŸ You have Equity Access with enhanced community support.\n\n`;
            }
            
            welcome += `âœ¨ **ENHANCED FEATURES NOW AVAILABLE:**\nâœï¸ Edit & delete your messages\nğŸ™ Prayer requests with community sharing\nğŸ“– Bible verse lookup and study\nğŸ¤ Voice input and ğŸ”Š text-to-speech\nğŸ“ File upload for biblical analysis\nğŸ’¾ Export conversations\nğŸ“œ Smart conversation history\nğŸ”— Live Dify API connection\n\nThis is a real-time group chat where everyone sees all messages. WayMaker AI responds to biblical questions and spiritual guidance requests.\n\n"For where two or three gather in my name, there am I with them." - Matthew 18:20 NIV`;
            
            this.addMessageToUI(welcome, 'assistant', 'WayMaker AI', true);
            console.log('âœ… Welcome message added successfully');
        } catch (error) {
            console.error('âŒ Error adding welcome message:', error);
        }
    }
    
    async sendMessage() {
        try {
            const message = this.messageInput?.value?.trim();
            if (!message) return;
            
            // Check if we're in edit mode
            if (this.editingMessageId) {
                this.saveMessageEdit(message);
                return;
            }
            
            this.addMessageToUI(message, 'user', this.userInfo.name);
            await this.broadcastMessage(message, 'user', this.userInfo.name);
            
            this.messageInput.value = '';
            
            const lowerMessage = message.toLowerCase();
            let historyType = 'Message';
            let historyIcon = 'ğŸ’¬';
            
            if (lowerMessage.includes('bible') || lowerMessage.includes('scripture') || lowerMessage.includes('verse')) {
                historyType = 'Bible Study';
                historyIcon = 'ğŸ“–';
            } else if (lowerMessage.includes('prayer') || lowerMessage.includes('pray')) {
                historyType = 'Prayer Request';
                historyIcon = 'ğŸ™';
            }
            
            this.addToHistory(historyType, message, historyIcon);
            
            if (this.shouldWayMakerRespond(message)) {
                this.showTyping();
                
                try {
                    const response = await this.callDifyAPI(message);
                    this.hideTyping();
                    
                    if (response && response !== '(silence)') {
                        this.addMessageToUI(response, 'assistant', 'WayMaker AI', true);
                        await this.broadcastMessage(response, 'assistant', 'WayMaker AI', true);
                        this.updateApiStatus('connected', 'Response received');
                    } else {
                        const fallback = this.getFallbackResponse(message);
                        if (fallback !== '(silence)') {
                            this.addMessageToUI(fallback, 'assistant', 'WayMaker AI', true);
                            await this.broadcastMessage(fallback, 'assistant', 'WayMaker AI', true);
                            this.updateApiStatus('fallback', 'Using fallback response');
                        }
                    }
                } catch (error) {
                    this.hideTyping();
                    console.error('âŒ Dify API Error:', error);
                    const fallback = this.getFallbackResponse(message);
                    if (fallback !== '(silence)') {
                        this.addMessageToUI(fallback, 'assistant', 'WayMaker AI', true);
                        await this.broadcastMessage(fallback, 'assistant', 'WayMaker AI', true);
                    }
                    this.updateApiStatus('fallback', 'API error - using fallback');
                }
            }
        } catch (error) {
            console.error('âŒ Error sending message:', error);
        }
    }
    
    shouldWayMakerRespond(message) {
        const lowerMessage = message.toLowerCase();
        
        return lowerMessage.includes('waymaker') ||
               lowerMessage.includes('bible') || lowerMessage.includes('scripture') || lowerMessage.includes('verse') ||
               lowerMessage.includes('prayer') || lowerMessage.includes('pray') ||
               lowerMessage.includes('jesus') || lowerMessage.includes('god') || lowerMessage.includes('faith') ||
               lowerMessage.includes('guidance') || lowerMessage.includes('help') ||
               lowerMessage.includes('wisdom') || lowerMessage.includes('spiritual');
    }
    
    async callDifyAPI(message, retryCount = 0) {
        const lowerMessage = message.toLowerCase();
        let spiritual_context = 'group discussion';
        let crisis_level = 'none';
        
        if (lowerMessage.includes('doubt') || lowerMessage.includes('losing faith')) {
            spiritual_context = 'faith crisis';
            crisis_level = 'serious';
        } else if (lowerMessage.includes('death') || lowerMessage.includes('grief')) {
            spiritual_context = 'grief and loss';
            crisis_level = 'serious';
        } else if (lowerMessage.includes('prayer')) {
            spiritual_context = 'prayer support';
        } else if (lowerMessage.includes('bible')) {
            spiritual_context = 'biblical study';
        } else if (lowerMessage.includes('struggling')) {
            spiritual_context = 'personal struggle';
            crisis_level = 'mild';
        }
        
        // Simplified payload with ONLY the 4 variables Dify expects
const payload = {
    inputs: {
        user_name: this.userInfo.name,
        user_age: this.userInfo.age,
        topic: message, // Keep full message without truncation
        registration_type: this.userInfo.type
    },
    query: message,
    response_mode: 'blocking',
    user: this.userInfo.name
};
        
        if (this.conversationId) {
            payload.conversation_id = this.conversationId;
        }
        
        try {
            const response = await fetch(this.apiUrl, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + this.apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                if (response.status === 404 && retryCount < 3) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return this.callDifyAPI(message, retryCount + 1);
                }
                throw new Error(`API call failed: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.conversation_id) {
                this.conversationId = data.conversation_id;
            }
            
            if (data.message_id) {
                this.currentMessageId = data.message_id;
            }
            
            const apiResponse = data.answer || data.data?.answer || data.message;
            if (apiResponse && apiResponse.trim() && apiResponse !== '(silence)') {
                this.lastApiSuccess = new Date();
                return apiResponse;
            } else {
                throw new Error('No valid API response received');
            }
            
        } catch (fetchError) {
            if (retryCount < 3) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                return this.callDifyAPI(message, retryCount + 1);
            }
            throw fetchError;
        }
    }
    
    getFallbackResponse(message) {
        const lowerMessage = message.toLowerCase();
        let fallback = `Peace be with you, ${this.userInfo.name}! `;
        
        if (lowerMessage.includes('waymaker') || lowerMessage.includes('help')) {
            fallback += 'I\'m here to help our community grow in faith. "Ask and it will be given to you; seek and you will find; knock and the door will be opened to you." - Matthew 7:7 NIV\n\nI\'m currently having some connection issues with our enhanced API. Please try again or check our connection status in the sidebar.';
            return fallback;
        }
        
        if (!lowerMessage.includes('god') && !lowerMessage.includes('jesus') && 
            !lowerMessage.includes('faith') && !lowerMessage.includes('waymaker') &&
            !lowerMessage.includes('prayer') && !lowerMessage.includes('bible')) {
            return '(silence)';
        }
        
        fallback += 'I\'m here to provide biblical guidance for our community. While I\'m experiencing some technical difficulties with our live API, I can still offer biblical encouragement. Please try again, and I\'ll do my best to help with God\'s wisdom. ğŸ™';
        return fallback;
    }
    
    addMessageToUI(content, type, sender, shouldStream = false) {
        if (content === '(silence)') return;
        
        try {
            const messageDiv = document.createElement('div');
            const messageId = 'msg_' + (++this.messageCounter);
            messageDiv.id = messageId;
            messageDiv.className = 'message group';
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const isUser = type === 'user';
            const isCurrentUser = sender === this.userInfo.name;
            
            // Enhanced message with edit/delete functionality
            messageDiv.innerHTML = 
                '<div class="flex ' + (isCurrentUser ? 'justify-end' : 'justify-start') + '">' +
                    '<div class="max-w-2xl">' +
                        '<div class="flex justify-between items-center mb-1 text-xs text-gray-400">' +
                            '<strong class="text-' + (isUser ? (isCurrentUser ? 'yellow' : 'blue') : 'green') + '-400">' + sender + (isCurrentUser ? ' (you)' : '') + '</strong>' +
                            '<div class="flex items-center gap-2">' +
                                '<span>' + time + '</span>' +
                                (isCurrentUser && isUser ? 
                                    '<div class="message-actions flex gap-1 opacity-0">' +
                                        '<button class="action-button edit" onclick="chat.startEditMessage(\'' + messageId + '\')">âœï¸</button>' +
                                        '<button class="action-button delete" onclick="chat.deleteMessage(\'' + messageId + '\')">âŒ</button>' +
                                    '</div>' : '') +
                            '</div>' +
                        '</div>' +
                        '<div class="message-content compact-message p-2 rounded-xl whitespace-pre-wrap ' + 
                            (isUser ? (isCurrentUser ? 'bg-blue-600 text-white' : 'bg-purple-600 text-white') : 'bg-gray-800 text-gray-100 border border-gray-700') + '">' +
                            (shouldStream ? '' : content) +
                        '</div>' +
                    '</div>' +
                '</div>';
            
            if (this.messagesContainer) {
                this.messagesContainer.appendChild(messageDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }
            
            if (shouldStream && type === 'assistant') {
                this.typeMessage(messageId, content);
            }
            
            return messageId;
        } catch (error) {
            console.error('âŒ Error adding message to UI:', error);
        }
    }

    // Enhanced Message Edit/Delete Functionality
    startEditMessage(messageId) {
        try {
            if (this.editingMessageId) {
                this.cancelMessageEdit();
            }
            
            const messageEl = document.getElementById(messageId);
            const contentEl = messageEl?.querySelector('.message-content');
            
            if (!messageEl || !contentEl) return;
            
            // Store original content
            this.originalMessageContent = contentEl.textContent;
            this.editingMessageId = messageId;
            
            // Add edit mode styling
            messageEl.classList.add('edit-mode');
            
            // Replace content with input
            contentEl.innerHTML = `
                <textarea class="w-full bg-gray-600 text-white p-2 rounded border border-blue-400 resize-none" 
                          rows="3" id="editInput">${this.originalMessageContent}</textarea>
                <div class="edit-controls">
                    <button class="action-button" onclick="chat.saveMessageEdit()">ğŸ’¾ Save</button>
                    <button class="action-button" onclick="chat.cancelMessageEdit()">âŒ Cancel</button>
                </div>
            `;
            
            // Focus the input
            const editInput = document.getElementById('editInput');
            if (editInput) {
                editInput.focus();
                editInput.setSelectionRange(editInput.value.length, editInput.value.length);
            }
            
            // Update message input behavior
            if (this.messageInput) {
                this.messageInput.placeholder = "Click Save to confirm edit, or Cancel to revert...";
            }
            if (this.sendButton) {
                this.sendButton.textContent = "Save Edit";
            }
        } catch (error) {
            console.error('âŒ Error starting message edit:', error);
        }
    }
    
    saveMessageEdit(newContent = null) {
        try {
            if (!this.editingMessageId) return;
            
            const messageEl = document.getElementById(this.editingMessageId);
            const editInput = document.getElementById('editInput');
            const contentEl = messageEl?.querySelector('.message-content');
            
            if (!messageEl || !contentEl) return;
            
            const updatedContent = newContent || editInput?.value || this.messageInput?.value;
            
            if (!updatedContent?.trim()) {
                alert('Message cannot be empty!');
                return;
            }
            
            // Update the message content
            contentEl.innerHTML = updatedContent;
            
            // Remove edit mode
            messageEl.classList.remove('edit-mode');
            
            // Reset editing state
            this.editingMessageId = null;
            this.originalMessageContent = '';
            if (this.messageInput) {
                this.messageInput.placeholder = "Share with community, ask questions, or request prayer...";
                this.messageInput.value = '';
            }
            if (this.sendButton) {
                this.sendButton.textContent = "Send";
            }
            
            // Show notification
            this.showNotification('âœ… Message updated successfully!', 'green');
            
            // Add to history
            this.addToHistory('Message Edit', updatedContent, 'âœï¸');
        } catch (error) {
            console.error('âŒ Error saving message edit:', error);
        }
    }
    
    cancelMessageEdit() {
        try {
            if (!this.editingMessageId) return;
            
            const messageEl = document.getElementById(this.editingMessageId);
            const contentEl = messageEl?.querySelector('.message-content');
            
            if (!messageEl || !contentEl) return;
            
            // Restore original content
            contentEl.innerHTML = this.originalMessageContent;
            
            // Remove edit mode
            messageEl.classList.remove('edit-mode');
            
            // Reset editing state
            this.editingMessageId = null;
            this.originalMessageContent = '';
            if (this.messageInput) {
                this.messageInput.placeholder = "Share with community, ask questions, or request prayer...";
                this.messageInput.value = '';
            }
            if (this.sendButton) {
                this.sendButton.textContent = "Send";
            }
            
            // Show notification
            this.showNotification('â†©ï¸ Edit cancelled', 'gray');
        } catch (error) {
            console.error('âŒ Error cancelling message edit:', error);
        }
    }
    
    deleteMessage(messageId) {
        try {
            const messageEl = document.getElementById(messageId);
            const contentEl = messageEl?.querySelector('.message-content');
            
            if (!messageEl || !contentEl) return;
            
            const messageContent = contentEl.textContent;
            
            if (confirm(`Delete this message?\n\n"${messageContent.substring(0, 100)}${messageContent.length > 100 ? '...' : ''}"`)) {
                // Add deleted indicator
                contentEl.innerHTML = '<em class="text-gray-500">This message was deleted</em>';
                contentEl.className = contentEl.className.replace(/bg-\w+-\d+/, 'bg-gray-600');
                
                // Remove action buttons
                const actionsEl = messageEl.querySelector('.message-actions');
                if (actionsEl) actionsEl.remove();
                
                // Show notification
                this.showNotification('ğŸ—‘ï¸ Message deleted', 'red');
                
                // Add to history
                this.addToHistory('Message Deletion', messageContent.substring(0, 50), 'ğŸ—‘ï¸');
            }
        } catch (error) {
            console.error('âŒ Error deleting message:', error);
        }
    }
    
    showNotification(message, color = 'blue') {
        try {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 bg-${color}-600 text-white px-3 py-2 rounded-lg shadow-lg z-50 text-sm`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        } catch (error) {
            console.error('âŒ Error showing notification:', error);
        }
    }
    
    async typeMessage(messageId, fullText) {
        try {
            const messageElement = document.getElementById(messageId);
            const contentDiv = messageElement?.querySelector('.message-content');
            
            if (!contentDiv) return;
            
            contentDiv.innerHTML = '<span class="typing-cursor">â–Š</span>';
            
            let displayedText = '';
            const words = fullText.split(' ');
            
            const baseDelay = 25;
            const wordDelay = 80;
            const punctuationDelay = 150;
            
            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                displayedText += (i > 0 ? ' ' : '') + word;
                
                contentDiv.innerHTML = displayedText + '<span class="typing-cursor animate-pulse">â–Š</span>';
                if (this.messagesContainer) {
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }
                
                let delay = baseDelay * word.length + wordDelay;
                
                if (word.includes('.') || word.includes('!') || word.includes('?') || word.includes(':')) {
                    delay += punctuationDelay;
                }
                
                if (word.match(/\d+:\d+/) || word.includes('NIV') || word.includes('ESV')) {
                    delay += punctuationDelay;
                }
                
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            
            contentDiv.innerHTML = displayedText;
            
            contentDiv.style.transform = 'scale(1.01)';
            setTimeout(() => {
                contentDiv.style.transform = 'scale(1)';
                contentDiv.style.transition = 'transform 0.2s ease';
            }, 200);
        } catch (error) {
            console.error('âŒ Error typing message:', error);
        }
    }
    
    showTyping() {
        try {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing';
            typingDiv.className = 'flex justify-start';
            typingDiv.innerHTML = 
                '<div class="max-w-2xl">' +
                    '<div class="p-2 bg-gray-800 border border-gray-700 rounded-xl">' +
                        '<div class="flex items-center gap-2 text-gray-400 italic text-sm">' +
                            '<div class="flex gap-1">' +
                                '<div class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce"></div>' +
                                '<div class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>' +
                                '<div class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>' +
                            '</div>' +
                            '<span>WayMaker AI is reflecting...</span>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            
            if (this.messagesContainer) {
                this.messagesContainer.appendChild(typingDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }
        } catch (error) {
            console.error('âŒ Error showing typing indicator:', error);
        }
    }
    
    hideTyping() {
        try {
            const typingDiv = document.getElementById('typing');
            if (typingDiv) {
                typingDiv.remove();
            }
        } catch (error) {
            console.error('âŒ Error hiding typing indicator:', error);
        }
    }
    
    // Enhanced Feature Handlers
    
    clearChat() {
        if (confirm('Clear all messages from this chat session?\n\nThis will only clear your local view - other community members will still see their messages.')) {
            if (this.messagesContainer) {
                this.messagesContainer.innerHTML = '';
            }
            this.messageCounter = 0;
            this.addWelcomeMessage();
            this.showNotification('ğŸ—‘ï¸ Chat cleared locally', 'gray');
        }
    }
    
    startVoiceInput() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = this.userInfo.language === 'Spanish' ? 'es-ES' : 'en-US';
            
            recognition.onstart = () => {
                if (this.voiceBtn) {
                    this.voiceBtn.textContent = 'ğŸ›‘';
                    this.voiceBtn.style.backgroundColor = '#ef4444';
                }
            };
            
            recognition.onresult = (event) => {
                if (this.messageInput) {
                    this.messageInput.value = event.results[0][0].transcript;
                    this.messageInput.focus();
                }
            };
            
            recognition.onend = () => {
                if (this.voiceBtn) {
                    this.voiceBtn.textContent = 'ğŸ¤';
                    this.voiceBtn.style.backgroundColor = '';
                }
            };
            
            recognition.start();
        } else {
            alert('Voice input not supported in this browser');
        }
    }
    
    handleFileUpload(event) {
        const files = event.target.files;
        if (!files.length) return;
        
        for (const file of files) {
            const message = 'ğŸ“ Shared file with community: ' + file.name + '\n\nWayMaker AI, please provide biblical insights on this file for our group.';
            this.addMessageToUI(message, 'user', this.userInfo.name);
            this.broadcastMessage(message, 'user', this.userInfo.name);
            
            this.addToHistory('File Upload', file.name, 'ğŸ“');
            
            setTimeout(() => {
                const response = `Thank you, ${this.userInfo.name}, for sharing "${file.name}" with our community.\n\n"Your word is a lamp for my feet, a light on my path." - Psalm 119:105 NIV\n\nPlease share what specific aspects you'd like our community to explore from a biblical perspective.`;
                this.addMessageToUI(response, 'assistant', 'WayMaker AI', true);
                this.broadcastMessage(response, 'assistant', 'WayMaker AI', true);
            }, 1000);
        }
        
        event.target.value = '';
    }
    
    handlePrayerRequest() {
        const prayer = prompt('Share your prayer request with the community:');
        if (prayer && prayer.trim()) {
            const message = 'ğŸ™ Prayer Request for Community: ' + prayer + '\n\nWayMaker AI, please provide biblical encouragement for this prayer request.';
            this.addMessageToUI(message, 'user', this.userInfo.name);
            this.broadcastMessage(message, 'user', this.userInfo.name);
            
            this.addToHistory('Prayer Request', prayer, 'ğŸ™');
            
            setTimeout(() => {
                const response = `Let us pray together for ${this.userInfo.name}:\n\n"Heavenly Father, we lift up this prayer request: ${prayer}\n\nLord, we ask for Your peace and guidance. Help us trust Your perfect timing.\n\n'And we know that in all things God works for the good of those who love him.' - Romans 8:28 NIV\n\nOur community stands with you in prayer. ğŸ™â¤ï¸"`;
                this.addMessageToUI(response, 'assistant', 'WayMaker AI', true);
                this.broadcastMessage(response, 'assistant', 'WayMaker AI', true);
            }, 1000);
        }
    }
    
    handleVerseLookup() {
        const verse = prompt('Enter a Bible verse reference to share with the community (e.g., John 3:16):');
        if (verse && verse.trim()) {
            const message = 'ğŸ“– Bible Study for Community: Please explain ' + verse + ' with biblical context and application.';
            this.addMessageToUI(message, 'user', this.userInfo.name);
            this.broadcastMessage(message, 'user', this.userInfo.name);
            
            this.addToHistory('Bible Study', verse, 'ğŸ“–');
            
            setTimeout(() => {
                const response = `Here's guidance on ${verse} for our community:\n\nFor the exact text, please consult your Bible. I can share biblical wisdom on this topic:\n\n"All Scripture is God-breathed and useful for teaching." - 2 Timothy 3:16 NIV\n\nHow would our community like to explore the themes from this passage together?`;
                this.addMessageToUI(response, 'assistant', 'WayMaker AI', true);
                this.broadcastMessage(response, 'assistant', 'WayMaker AI', true);
            }, 1000);
        }
    }
    
    exportConversation() {
        try {
            const messages = [];
            const messageElements = this.messagesContainer?.querySelectorAll('.message');
            
            if (messageElements) {
                messageElements.forEach(el => {
                    if (el.id === 'typing') return;
                    
                    const sender = el.querySelector('strong')?.textContent || 'Unknown';
                    const content = el.querySelector('.message-content')?.textContent || '';
                    const timestamp = el.querySelector('span')?.textContent || '';
                    
                    messages.push('[' + timestamp + '] ' + sender + ': ' + content);
                });
            }
            
            const sessionInfo = `Enhanced Group Chat Export\nUser: ${this.userInfo.name}\nAge: ${this.userInfo.age}\nType: ${this.userInfo.type}\nAccess: ${this.userInfo.access}\nLanguage: ${this.userInfo.language}`;
            
            const exportText = `WayMaker AI Enhanced Group Chat Export\n${'='.repeat(50)}\nExported: ${new Date().toLocaleString()}\n\n${sessionInfo}\n\n${'='.repeat(50)}\n\n${messages.join('\n\n')}`;
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `waymaker-enhanced-chat-${this.userInfo.name}-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (error) {
            console.error('âŒ Error exporting conversation:', error);
        }
    }
    
    startNewSession() {
        if (confirm('Start a new session? This will return you to the welcome page and end your group chat participation.')) {
            window.location.href = 'auth.html';
        }
    }
    
    exitChat() {
        const userName = this.userInfo.name;
        
        const exitMessage = `${userName}, are you sure you want to exit the WayMaker AI enhanced group chat?\n\n` +
                          `You'll leave the community discussion and session data will be cleared.\n` +
                          `You can always return anytime - just visit our welcome page again!\n\n` +
                          `"The Lord your God will be with you wherever you go." - Joshua 1:9`;
        
        if (confirm(exitMessage)) {
            this.cleanup();
            window.location.href = 'index.html';
        }
    }
}

// Initialize enhanced group chat when page loads
let chat;
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ DOM loaded, starting enhanced group chat...');
    
    try {
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.get('name')) {
            console.log('No user session found, redirecting to auth...');
            window.location.href = 'auth.html';
            return;
        }
        
        window.chat = new WayMakerGroupChat();
        
        // Initialize admin extension
        setTimeout(() => {
            if (typeof initializeWayMakerAdmin === 'function') {
                initializeWayMakerAdmin();
            }
        }, 500);
        
        const style = document.createElement('style');
        style.textContent = '.message:hover .message-actions { opacity: 1 !important; }';
        document.head.appendChild(style);
        
        console.log('âœ… WayMaker AI Enhanced Community Chat initialized successfully');
    } catch (error) {
        console.error('âŒ Failed to initialize chat:', error);
        
        // Show error message to user
        const userInfoDisplay = document.getElementById('userInfoDisplay');
        if (userInfoDisplay) {
            userInfoDisplay.innerHTML = '<span class="text-red-400">âš ï¸ Failed to initialize chat. Please refresh the page.</span>';
        }
    }
});

console.log('âœ… WayMaker AI Enhanced Community Chat script loaded successfully');
</script>

</body>
</html>
